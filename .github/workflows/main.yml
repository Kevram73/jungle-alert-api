name: Deploy on production mode (pressingelegance.com)

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:


jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Create deployment archive
        run: |
          tar --exclude='.git' \
              --exclude='.github' \
              --exclude='node_modules' \
              --exclude='vendor' \
              --exclude='.env' \
              --exclude='docker.env' \
              --exclude='storage/logs' \
              --exclude='storage/framework/cache' \
              --exclude='storage/framework/sessions' \
              --exclude='storage/framework/views' \
              --exclude='bootstrap/cache' \
              --exclude='tests' \
              --exclude='.phpunit.cache' \
              --exclude='certbot_data' \
              --exclude='certbot_www' \
              --exclude='deploy.tar.gz' \
              --exclude='*.log' \
              -czf /tmp/deploy.tar.gz .
          mv /tmp/deploy.tar.gz ./deploy.tar.gz

      - name: ðŸ“¤ Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          source: "deploy.tar.gz"
          target: ${{ secrets.SFTP_DEPLOY_PATH || '/var/www/pretconnectloan' }}

      - name: ðŸ“‚ Extract files on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          script: |
            cd ${{ secrets.SFTP_DEPLOY_PATH || '/var/www/pretconnectloan' }}
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            echo "âœ… Fichiers dÃ©ployÃ©s avec succÃ¨s"