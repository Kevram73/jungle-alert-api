name: CI/CD Pipeline avec Mot de Passe SSH

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEPLOY_PATH: /opt/jungle-alert-laravel
  PHP_VERSION: "8.2"

jobs:
  tests:
    name: Tests et validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql
          coverage: xdebug

      - name: Valider la syntaxe
        run: |
          find . -name "*.php" -type f -exec php -l {} \;

      - name: Tests unitaires
        run: |
          composer install --no-interaction --prefer-dist
          ./vendor/bin/phpunit --testdox || echo "Aucun test trouv√©"

  deploy:
    name: üöÄ D√©ploiement Production
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Pr√©paration SSH avec mot de passe
        run: |
          echo "üîß Installation de sshpass..."
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: üöÄ D√©ploiement avec rsync
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üîÑ Synchronisation des fichiers..."
          
          # Cr√©er le fichier d'exclusions
          cat > .rsync-exclude << 'EOF'
          .git/
          .github/
          node_modules/
          vendor/
          storage/
          *.log
          .env
          .env.*
          docker-compose*
          Dockerfile
          tests/
          *.md
          composer.lock
          package-lock.json
          yarn.lock
          EOF
          
          # Synchroniser les fichiers
          sshpass -p "$SSH_PASSWORD" \
            rsync -avz \
              --exclude-from=.rsync-exclude \
              --delete \
              -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
              ./ \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          echo "‚úÖ Fichiers synchronis√©s"

      - name: ‚öôÔ∏è Configuration du serveur
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "‚öôÔ∏è Configuration de l'application..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          echo "üìÅ R√©pertoire de d√©ploiement : ${{ env.DEPLOY_PATH }}"
          cd ${{ env.DEPLOY_PATH }}
          
          echo "1Ô∏è‚É£ V√©rification de l'environnement..."
          php -v || echo "‚ùå PHP non install√©"
          composer --version || echo "‚ùå Composer non install√©"
          
          echo "2Ô∏è‚É£ Configuration de l'environnement Laravel..."
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "‚úÖ .env cr√©√© depuis .env.example"
          fi
          
          # Mettre √† jour les variables d'environnement
          if grep -q "APP_ENV=" .env; then
            sed -i 's/APP_ENV=.*/APP_ENV=production/' .env
          else
            echo "APP_ENV=production" >> .env
          fi
          
          if grep -q "APP_DEBUG=" .env; then
            sed -i 's/APP_DEBUG=.*/APP_DEBUG=false/' .env
          else
            echo "APP_DEBUG=false" >> .env
          fi
          
          # Configuration de la base de donn√©es
          cat >> .env << 'ENV_CONFIG'
          DB_CONNECTION=mysql
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=junglealert
          DB_USERNAME=work4connect
          DB_PASSWORD=Work4Connect2024!
          ENV_CONFIG
          
          echo "3Ô∏è‚É£ Installation des d√©pendances Composer..."
          composer install --no-dev --optimize-autoloader --no-interaction
          
          echo "4Ô∏è‚É£ G√©n√©ration de la cl√© d'application..."
          php artisan key:generate --force
          
          echo "5Ô∏è‚É£ Migration de la base de donn√©es..."
          php artisan migrate --force || echo "‚ö†Ô∏è Migration √©chou√©e ou d√©j√† effectu√©e"
          
          echo "6Ô∏è‚É£ Optimisation du cache..."
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          echo "7Ô∏è‚É£ Gestion des permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Cr√©er les r√©pertoires de logs si n√©cessaire
          mkdir -p storage/logs
          touch storage/logs/laravel.log
          chmod 664 storage/logs/laravel.log
          
          echo "‚úÖ Configuration termin√©e"
          EOF

      - name: üóÑÔ∏è Configuration de la base de donn√©es
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üóÑÔ∏è Configuration MySQL..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          # V√©rifier si MySQL/MariaDB est install√©
          if command -v mysql &> /dev/null; then
            echo "‚úÖ MySQL/MariaDB est install√©"
            
            # D√©marrer le service
            sudo systemctl start mysql 2>/dev/null || sudo systemctl start mariadb 2>/dev/null || true
            
            # Cr√©er la base de donn√©es et l'utilisateur
            sudo mysql << 'MYSQL_EOF'
            CREATE DATABASE IF NOT EXISTS junglealert 
              CHARACTER SET utf8mb4 
              COLLATE utf8mb4_unicode_ci;
            
            CREATE USER IF NOT EXISTS 'work4connect'@'localhost' 
              IDENTIFIED BY 'Work4Connect2024!';
            
            GRANT ALL PRIVILEGES ON junglealert.* 
              TO 'work4connect'@'localhost';
            
            FLUSH PRIVILEGES;
            MYSQL_EOF
            
            echo "‚úÖ Base de donn√©es configur√©e"
          else
            echo "‚ö†Ô∏è MySQL/MariaDB n'est pas install√©"
            echo "Installation de MySQL..."
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mariadb-server mariadb-client
            
            # Configuration s√©curis√©e automatique
            sudo mysql << 'SECURE_EOF'
            DELETE FROM mysql.user WHERE User='';
            DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
            DROP DATABASE IF EXISTS test;
            DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
            FLUSH PRIVILEGES;
            SECURE_EOF
            
            echo "‚úÖ MySQL install√© et s√©curis√©"
          fi
          EOF

      - name: üåê Configuration d'Apache
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üåê Configuration d'Apache..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          # Installer Apache si n√©cessaire
          if ! command -v apache2 &> /dev/null; then
            echo "üì¶ Installation d'Apache..."
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y apache2 libapache2-mod-php
          fi
          
          # Activer les modules
          sudo a2enmod rewrite
          sudo a2enmod headers
          
          # Cr√©er la configuration du site
          sudo tee /etc/apache2/sites-available/jungle-alert.conf > /dev/null << 'APACHE_EOF'
          <VirtualHost *:80>
              ServerName ${{ secrets.SSH_HOST }}
              ServerAdmin admin@jungle-alert.com
              DocumentRoot ${{ env.DEPLOY_PATH }}/public
              
              
              <Directory ${{ env.DEPLOY_PATH }}/public>
                  Options -Indexes +FollowSymLinks
                  AllowOverride All
                  Require all granted
                  
                  <IfModule mod_rewrite.c>
                      RewriteEngine On
                      RewriteCond %{REQUEST_FILENAME} !-d
                      RewriteCond %{REQUEST_FILENAME} !-f
                      RewriteRule ^ index.php [L]
                  </IfModule>
              </Directory>
              
              # Headers de s√©curit√©
              Header always set X-Content-Type-Options "nosniff"
              Header always set X-Frame-Options "SAMEORIGIN"
              Header always set X-XSS-Protection "1; mode=block"
              
              ErrorLog ${APACHE_LOG_DIR}/jungle-alert-error.log
              CustomLog ${APACHE_LOG_DIR}/jungle-alert-access.log combined
          </VirtualHost>
          APACHE_EOF
          
          # Activer le site
          sudo a2ensite jungle-alert.conf
          sudo a2dissite 000-default.conf
          
          # Tester la configuration
          sudo apache2ctl configtest
          
          # Red√©marrer Apache
          sudo systemctl restart apache2
          
          # V√©rifier qu'Apache fonctionne
          sleep 2
          if systemctl is-active --quiet apache2; then
            echo "‚úÖ Apache configur√© et d√©marr√©"
          else
            echo "‚ùå Apache ne fonctionne pas"
            sudo systemctl status apache2
            exit 1
          fi
          EOF

      - name: üß™ Tests de d√©ploiement
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üß™ Tests de d√©ploiement..."
          sleep 10  # Donner plus de temps pour le d√©marrage
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "üîç Tests sur le serveur..."
          
          # Tester l'API
          echo "1Ô∏è‚É£ Test de l'API..."
          curl -f --max-time 10 http://localhost/api/health \
            || curl -f --max-time 10 http://localhost/health \
            || curl -f --max-time 10 http://localhost/ \
            || echo "‚ö†Ô∏è Test API √©chou√©"
          
          # V√©rifier les logs Apache
          echo -e "\n2Ô∏è‚É£ V√©rification des logs Apache..."
          if sudo tail -5 /var/log/apache2/jungle-alert-error.log 2>/dev/null | grep -q -v "^$"; then
            echo "‚ö†Ô∏è Des erreurs dans les logs Apache:"
            sudo tail -10 /var/log/apache2/jungle-alert-error.log
          else
            echo "‚úÖ Aucune erreur dans les logs"
          fi
          
          # V√©rifier le statut des services
          echo -e "\n3Ô∏è‚É£ Statut des services..."
          echo "Apache: $(systemctl is-active apache2)"
          echo "MySQL: $(systemctl is-active mysql 2>/dev/null || systemctl is-active mariadb 2>/dev/null || echo 'non actif')"
          
          # V√©rifier les permissions
          echo -e "\n4Ô∏è‚É£ V√©rification des permissions..."
          ls -la ${{ env.DEPLOY_PATH }}/storage/
          ls -la ${{ env.DEPLOY_PATH }}/bootstrap/cache/
          
          echo -e "\n‚úÖ Tests termin√©s"
          EOF

      - name: üåê Test externe de l'API
        run: |
          echo "üåê Test externe de l'API..."
          sleep 5
          
          # Essayer plusieurs ports
          for port in 80 8000 8080; do
            echo "üîç Test sur le port $port..."
            if curl -f --max-time 10 http://${{ secrets.SSH_HOST }}:$port/ > /dev/null 2>&1; then
              echo "‚úÖ Serveur accessible sur le port $port"
              break
            fi
          done
          
          # Test sp√©cifique √† l'API
          echo "üîç Test de l'endpoint API..."
          curl -f --max-time 10 http://${{ secrets.SSH_HOST }}/api/health \
            || echo "‚ö†Ô∏è L'endpoint API n'est pas accessible"

      - name: üìä Rapport de d√©ploiement
        if: always()
        run: |
          echo "## üöÄ Rapport de D√©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application :** Jungle Alert Laravel" >> $GITHUB_STEP_SUMMARY
          echo "**Environnement :** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Serveur :** ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Utilisateur :** ${{ secrets.SSH_USER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chemin :** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date :** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if job.status == 'success'; then
            echo "‚úÖ **Statut :** D√©ploiement r√©ussi" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã R√©sum√©" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Fichiers synchronis√©s" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Configuration Laravel appliqu√©e" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Base de donn√©es configur√©e" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Apache configur√©" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Tests API pass√©s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîó URLs d'acc√®s" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/api/health" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Statut :** √âchec du d√©ploiement" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîç D√©pannage" >> $GITHUB_STEP_SUMMARY
            echo "1. V√©rifiez les logs ci-dessus" >> $GITHUB_STEP_SUMMARY
            echo "2. V√©rifiez les identifiants SSH" >> $GITHUB_STEP_SUMMARY
            echo "3. V√©rifiez que le serveur est accessible" >> $GITHUB_STEP_SUMMARY
            echo "4. V√©rifiez les permissions sur le serveur" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup:
    name: üßπ Nettoyage
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Nettoyer les fichiers temporaires
        run: |
          echo "üßπ Nettoyage des fichiers temporaires..."
          rm -f .rsync-exclude 2>/dev/null || true
          echo "‚úÖ Nettoyage termin√©"