name: CI/CD Pipeline avec Mot de Passe SSH

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEPLOY_PATH: /opt/jungle-alert-laravel
  PHP_VERSION: "8.2"

jobs:
  tests:
    name: Tests et validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql, dom, curl, zip, gd
          coverage: xdebug

      - name: Valider la syntaxe
        run: |
          find . -name "*.php" -type f -exec php -l {} \;

      - name: Tests unitaires
        run: |
          composer install --no-interaction --prefer-dist
          ./vendor/bin/phpunit --testdox || echo "Aucun test trouv√©"

  deploy:
    name: üöÄ D√©ploiement Production
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Pr√©paration SSH avec mot de passe
        run: |
          echo "üîß Installation de sshpass..."
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: üöÄ D√©ploiement avec rsync
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üîÑ Synchronisation des fichiers..."
          
          # Cr√©er le fichier d'exclusions
          cat > .rsync-exclude << 'EOF'
          .git/
          .github/
          node_modules/
          vendor/
          storage/
          *.log
          .env
          .env.*
          docker-compose*
          Dockerfile
          tests/
          *.md
          composer.lock
          package-lock.json
          yarn.lock
          EOF
          
          # Synchroniser les fichiers
          sshpass -p "$SSH_PASSWORD" \
            rsync -avz \
              --exclude-from=.rsync-exclude \
              --delete \
              -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
              ./ \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          echo "‚úÖ Fichiers synchronis√©s"

      - name: ‚öôÔ∏è Pr√©paration du serveur (extensions PHP)
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üîß Installation des extensions PHP n√©cessaires..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EXTENSIONS_SCRIPT'
          set -ex
          
          echo "=== INSTALLATION DES EXTENSIONS PHP ==="
          
          # V√©rifier la version de PHP
          echo "üîç V√©rification de PHP..."
          php -v || echo "‚ö†Ô∏è PHP non install√©"
          
          # Installer PHP et les extensions n√©cessaires
          echo "üì¶ Installation des extensions PHP..."
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            php \
            php-cli \
            php-fpm \
            php-common \
            php-mysql \
            php-zip \
            php-gd \
            php-mbstring \
            php-curl \
            php-xml \
            php-bcmath \
            php-json \
            php-tokenizer \
            php-dom \
            php-xmlwriter \
            libapache2-mod-php
          
          # V√©rifier les extensions install√©es
          echo "‚úÖ Extensions install√©es :"
          php -m | grep -E "dom|xml|mbstring|curl|zip|gd|mysql|pdo|json"
          
          # Red√©marrer Apache pour prendre en charge les nouvelles extensions
          echo "üîÑ Red√©marrage d'Apache..."
          sudo systemctl restart apache2 || true
          
          # V√©rifier Composer
          if ! command -v composer &> /dev/null; then
            echo "üì¶ Installation de Composer..."
            curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
          else
            echo "‚úÖ Composer d√©j√† install√©"
          fi
          
          echo "=== PR√âPARATION TERMIN√âE ==="
          EXTENSIONS_SCRIPT

      - name: ‚öôÔ∏è Configuration du serveur
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "‚öôÔ∏è Configuration de l'application..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'CONFIG_SCRIPT'
          set -ex
          
          echo "üìÅ R√©pertoire de d√©ploiement : ${{ env.DEPLOY_PATH }}"
          cd ${{ env.DEPLOY_PATH }}
          
          echo "=== CONFIGURATION LARAVEL ==="
          
          echo "1Ô∏è‚É£ V√©rification de l'environnement..."
          php -v
          composer --version
          
          echo "2Ô∏è‚É£ Configuration de l'environnement Laravel..."
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "‚úÖ .env cr√©√© depuis .env.example"
          fi
          
          # Mettre √† jour les variables d'environnement
          if grep -q "APP_ENV=" .env; then
            sed -i 's/APP_ENV=.*/APP_ENV=production/' .env
          else
            echo "APP_ENV=production" >> .env
          fi
          
          if grep -q "APP_DEBUG=" .env; then
            sed -i 's/APP_DEBUG=.*/APP_DEBUG=false/' .env
          else
            echo "APP_DEBUG=false" >> .env
          fi
          
          # Configuration de la base de donn√©es
          echo "3Ô∏è‚É£ Configuration de la base de donn√©es..."
          cat >> .env << 'ENV_CONFIG'
          DB_CONNECTION=mysql
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=junglealert
          DB_USERNAME=work4connect
          DB_PASSWORD=Work4Connect2024!
          ENV_CONFIG
          
          echo "4Ô∏è‚É£ Installation des d√©pendances Composer..."
          # Ignorer temporairement les v√©rifications de plateforme
          composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs
          
          echo "5Ô∏è‚É£ G√©n√©ration de la cl√© d'application..."
          php artisan key:generate --force
          
          echo "6Ô∏è‚É£ Migration de la base de donn√©es..."
          php artisan migrate --force || echo "‚ö†Ô∏è Migration √©chou√©e ou d√©j√† effectu√©e"
          
          echo "7Ô∏è‚É£ Optimisation du cache..."
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          echo "8Ô∏è‚É£ Gestion des permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Cr√©er les r√©pertoires de logs si n√©cessaire
          mkdir -p storage/logs
          touch storage/logs/laravel.log
          chmod 664 storage/logs/laravel.log
          
          echo "‚úÖ Configuration termin√©e"
          CONFIG_SCRIPT

      - name: üóÑÔ∏è Configuration de la base de donn√©es
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üóÑÔ∏è Configuration MySQL..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'MYSQL_SCRIPT'
          set -ex
          
          echo "=== CONFIGURATION MYSQL ==="
          
          # V√©rifier si MySQL/MariaDB est install√©
          if command -v mysql &> /dev/null; then
            echo "‚úÖ MySQL/MariaDB est install√©"
            
            # D√©marrer le service
            sudo systemctl start mysql 2>/dev/null || sudo systemctl start mariadb 2>/dev/null || true
            
            # V√©rifier si la base de donn√©es existe d√©j√†
            if mysql -u root -e "SHOW DATABASES LIKE 'junglealert';" 2>/dev/null | grep -q junglealert; then
              echo "üìä Base de donn√©es 'junglealert' existe d√©j√†"
            else
              echo "üóÑÔ∏è Cr√©ation de la base de donn√©es..."
              sudo mysql -e "CREATE DATABASE IF NOT EXISTS junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>/dev/null || \
                sudo mysql -u root -p'Work4Connect2024!' -e "CREATE DATABASE IF NOT EXISTS junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>/dev/null || \
                echo "‚ö†Ô∏è Impossible de cr√©er la base de donn√©es"
              
              echo "üë§ Cr√©ation de l'utilisateur..."
              sudo mysql -e "CREATE USER IF NOT EXISTS 'work4connect'@'localhost' IDENTIFIED BY 'Work4Connect2024!';" 2>/dev/null || \
                sudo mysql -u root -p'Work4Connect2024!' -e "CREATE USER IF NOT EXISTS 'work4connect'@'localhost' IDENTIFIED BY 'Work4Connect2024!';" 2>/dev/null || \
                echo "‚ö†Ô∏è Impossible de cr√©er l'utilisateur"
              
              echo "üîë Attribution des droits..."
              sudo mysql -e "GRANT ALL PRIVILEGES ON junglealert.* TO 'work4connect'@'localhost';" 2>/dev/null || \
                sudo mysql -u root -p'Work4Connect2024!' -e "GRANT ALL PRIVILEGES ON junglealert.* TO 'work4connect'@'localhost';" 2>/dev/null || \
                echo "‚ö†Ô∏è Impossible d'attribuer les droits"
              
              sudo mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || \
                sudo mysql -u root -p'Work4Connect2024!' -e "FLUSH PRIVILEGES;" 2>/dev/null || \
                echo "‚ö†Ô∏è Impossible de flush les privil√®ges"
              
              echo "‚úÖ Base de donn√©es et utilisateur configur√©s"
            fi
          else
            echo "‚ö†Ô∏è MySQL/MariaDB n'est pas install√©"
            echo "Installation de MySQL..."
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mariadb-server mariadb-client
            
            # D√©marrer MySQL
            sudo systemctl start mariadb
            sudo systemctl enable mariadb
            
            # Configuration s√©curis√©e
            echo "üîß Configuration s√©curis√©e de MySQL..."
            
            # Essayer diff√©rentes m√©thodes de connexion
            sudo mysql << 'MYSQL_SECURE' 2>/dev/null || true
            ALTER USER 'root'@'localhost' IDENTIFIED BY 'Work4Connect2024!';
            DELETE FROM mysql.user WHERE User='';
            DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
            DROP DATABASE IF EXISTS test;
            DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
            FLUSH PRIVILEGES;
            MYSQL_SECURE
            
            # Cr√©er la base de donn√©es et l'utilisateur pour l'application
            sudo mysql -u root -p'Work4Connect2024!' << 'APP_DB' 2>/dev/null || true
            CREATE DATABASE junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
            CREATE USER 'work4connect'@'localhost' IDENTIFIED BY 'Work4Connect2024!';
            GRANT ALL PRIVILEGES ON junglealert.* TO 'work4connect'@'localhost';
            FLUSH PRIVILEGES;
            APP_DB
            
            echo "‚úÖ MySQL install√© et configur√©"
          fi
          
          echo "=== CONFIGURATION MYSQL TERMIN√âE ==="
          MYSQL_SCRIPT

      - name: üåê Configuration d'Apache
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üåê Configuration d'Apache..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'APACHE_SCRIPT'
          set -ex
          
          echo "=== CONFIGURATION APACHE ==="
          
          # Installer Apache si n√©cessaire
          if ! command -v apache2 &> /dev/null; then
            echo "üì¶ Installation d'Apache..."
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y apache2
          fi
          
          # Activer les modules
          echo "‚öôÔ∏è Activation des modules Apache..."
          sudo a2enmod rewrite
          sudo a2enmod headers
          
          # D√©sactiver le site par d√©faut
          echo "üö´ D√©sactivation du site par d√©faut..."
          sudo a2dissite 000-default.conf 2>/dev/null || true
          
          # Cr√©er la configuration du site
          echo "‚öôÔ∏è Cr√©ation de la configuration Apache..."
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          SERVER_HOST="${{ secrets.SSH_HOST }}"
          
          sudo tee /etc/apache2/sites-available/jungle-alert.conf > /dev/null << 'VIRTUAL_HOST'
          <VirtualHost *:80>
              ServerName ${SERVER_HOST}
              ServerAdmin admin@jungle-alert.com
              DocumentRoot ${DEPLOY_PATH}/public
              
              <Directory ${DEPLOY_PATH}/public>
                  Options -Indexes +FollowSymLinks
                  AllowOverride All
                  Require all granted
                  
                  <IfModule mod_rewrite.c>
                      RewriteEngine On
                      RewriteCond %{REQUEST_FILENAME} !-d
                      RewriteCond %{REQUEST_FILENAME} !-f
                      RewriteRule ^ index.php [L]
                  </IfModule>
              </Directory>
              
              # Headers de s√©curit√©
              Header always set X-Content-Type-Options "nosniff"
              Header always set X-Frame-Options "SAMEORIGIN"
              
              ErrorLog \${APACHE_LOG_DIR}/jungle-alert-error.log
              CustomLog \${APACHE_LOG_DIR}/jungle-alert-access.log combined
              
              # PHP configuration
              <FilesMatch \.php$>
                  SetHandler application/x-httpd-php
              </FilesMatch>
          </VirtualHost>
          VIRTUAL_HOST
          
          # Activer le site
          echo "‚úÖ Activation du site jungle-alert..."
          sudo a2ensite jungle-alert.conf
          
          # Tester la configuration
          echo "üîß Test de la configuration Apache..."
          sudo apache2ctl configtest
          
          # Red√©marrer Apache
          echo "üîÑ Red√©marrage d'Apache..."
          sudo systemctl restart apache2
          
          # V√©rifier qu'Apache fonctionne
          sleep 2
          if systemctl is-active --quiet apache2; then
            echo "‚úÖ Apache configur√© et d√©marr√©"
          else
            echo "‚ùå Apache ne fonctionne pas"
            echo "=== LOGS D'ERREUR ==="
            sudo journalctl -u apache2 --no-pager -n 30
            echo "=== FICHIER DE CONFIGURATION ==="
            sudo cat /etc/apache2/sites-available/jungle-alert.conf
            exit 1
          fi
          
          echo "=== CONFIGURATION APACHE TERMIN√âE ==="
          APACHE_SCRIPT

      - name: üß™ Tests de d√©ploiement
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üß™ Tests de d√©ploiement..."
          sleep 10
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'TEST_SCRIPT'
          set -ex
          
          echo "=== TESTS DE D√âPLOIEMENT ==="
          
          echo "1Ô∏è‚É£ V√©rification des services..."
          echo "Apache: $(systemctl is-active apache2)"
          echo "MySQL: $(systemctl is-active mysql 2>/dev/null || systemctl is-active mariadb 2>/dev/null || echo 'non actif')"
          
          echo "2Ô∏è‚É£ Test de l'application..."
          cd ${{ env.DEPLOY_PATH }}
          
          # Tester si Laravel r√©pond
          if php artisan --version; then
            echo "‚úÖ Laravel fonctionne"
          else
            echo "‚ùå Laravel ne fonctionne pas"
          fi
          
          # Tester la connexion √† la base de donn√©es
          echo "3Ô∏è‚É£ Test de la base de donn√©es..."
          if php artisan db:show 2>/dev/null || php artisan migrate:status 2>/dev/null; then
            echo "‚úÖ Connexion √† la base de donn√©es √©tablie"
          else
            echo "‚ö†Ô∏è Impossible de se connecter √† la base de donn√©es"
          fi
          
          # Tester l'application via curl
          echo "4Ô∏è‚É£ Test HTTP..."
          curl -I --max-time 5 http://localhost/ 2>/dev/null | head -1 || echo "‚ö†Ô∏è Application non accessible localement"
          
          echo "5Ô∏è‚É£ V√©rification des logs..."
          if [ -f storage/logs/laravel.log ]; then
            echo "‚úÖ Logs Laravel pr√©sents"
            tail -5 storage/logs/laravel.log
          fi
          
          echo "=== TESTS TERMIN√âS ==="
          TEST_SCRIPT

      - name: üåê Test externe de l'API
        run: |
          echo "üåê Test externe de l'API..."
          sleep 5
          
          # Tester la connexion au serveur
          echo "üîç Test de connectivit√©..."
          if curl -f --max-time 10 http://${{ secrets.SSH_HOST }}/ 2>/dev/null; then
            echo "‚úÖ Application accessible depuis l'ext√©rieur"
            echo "üîó URL: http://${{ secrets.SSH_HOST }}/"
          else
            echo "‚ö†Ô∏è Application non accessible depuis l'ext√©rieur"
            echo "Causes possibles :"
            echo "  - Pare-feu bloquant le port 80"
            echo "  - Probl√®me de configuration DNS"
            echo "  - Apache ne r√©pond pas sur l'IP publique"
          fi

      - name: üìä Rapport de d√©ploiement
        if: always()
        run: |
          echo "## üöÄ Rapport de D√©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application :** Jungle Alert Laravel" >> $GITHUB_STEP_SUMMARY
          echo "**Environnement :** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Serveur :** ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Utilisateur :** ${{ secrets.SSH_USER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chemin :** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date :** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if job.status == 'success'; then
            echo "‚úÖ **Statut :** D√©ploiement r√©ussi" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã R√©sum√©" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Extensions PHP install√©es" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Fichiers synchronis√©s" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Configuration Laravel appliqu√©e" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Base de donn√©es configur√©e" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Apache configur√©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîó URLs d'acc√®s" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/api/health" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Statut :** √âchec du d√©ploiement" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîç D√©pannage" >> $GITHUB_STEP_SUMMARY
            echo "1. V√©rifiez les logs ci-dessus" >> $GITHUB_STEP_SUMMARY
            echo "2. V√©rifiez que PHP et les extensions sont install√©es:" >> $GITHUB_STEP_SUMMARY
            echo "   - php -m" >> $GITHUB_STEP_SUMMARY
            echo "3. V√©rifiez les logs Apache:" >> $GITHUB_STEP_SUMMARY
            echo "   - /var/log/apache2/error.log" >> $GITHUB_STEP_SUMMARY
            echo "4. V√©rifiez les logs Laravel:" >> $GITHUB_STEP_SUMMARY
            echo "   - ${{ env.DEPLOY_PATH }}/storage/logs/laravel.log" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup:
    name: üßπ Nettoyage
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Nettoyer les fichiers temporaires
        run: |
          echo "üßπ Nettoyage des fichiers temporaires..."
          rm -f .rsync-exclude 2>/dev/null || true
          echo "‚úÖ Nettoyage termin√©"