name: CI/CD Pipeline avec Mot de Passe SSH

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEPLOY_PATH: /opt/jungle-alert-laravel
  PHP_VERSION: "8.2"

jobs:
  tests:
    name: Tests et validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql, curl, zip, gd
          coverage: xdebug

      - name: Valider la syntaxe
        run: |
          find . -name "*.php" -type f -exec php -l {} \;

      - name: Tests unitaires
        run: |
          composer install --no-interaction --prefer-dist
          ./vendor/bin/phpunit --testdox || echo "Aucun test trouv√©"

  deploy:
    name: üöÄ D√©ploiement Production
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Pr√©paration SSH avec mot de passe
        run: |
          echo "üîß Installation de sshpass..."
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: üöÄ D√©ploiement avec rsync
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üîÑ Synchronisation des fichiers..."
          
          # Cr√©er le fichier d'exclusions
          cat > .rsync-exclude << 'EOF'
          .git/
          .github/
          node_modules/
          vendor/
          storage/
          *.log
          .env
          .env.*
          docker-compose*
          Dockerfile
          tests/
          *.md
          composer.lock
          package-lock.json
          yarn.lock
          EOF
          
          # Synchroniser les fichiers
          sshpass -p "$SSH_PASSWORD" \
            rsync -avz \
              --exclude-from=.rsync-exclude \
              --delete \
              -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
              ./ \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          echo "‚úÖ Fichiers synchronis√©s"

      - name: ‚öôÔ∏è Configuration du serveur
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "‚öôÔ∏è Configuration de l'application..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'CONFIG_SCRIPT'
          set -ex
          
          echo "üìÅ R√©pertoire de d√©ploiement : ${{ env.DEPLOY_PATH }}"
          cd ${{ env.DEPLOY_PATH }}
          
          echo "=== CONFIGURATION LARAVEL ==="
          
          echo "1Ô∏è‚É£ V√©rification de l'environnement..."
          php -v
          composer --version
          
          echo "2Ô∏è‚É£ Configuration de l'environnement Laravel..."
          if [ ! -f .env ]; then
            echo "üìÑ Cr√©ation du fichier .env..."
            if [ -f .env.example ]; then
              cp .env.example .env
              echo "‚úÖ .env cr√©√© depuis .env.example"
            else
              echo "‚ùå .env.example non trouv√©"
              exit 1
            fi
          else
            echo "üìÑ .env existe d√©j√†"
          fi
          
          # Mettre √† jour les variables d'environnement
          echo "3Ô∏è‚É£ Mise √† jour des variables d'environnement..."
          
          # Fonction pour mettre √† jour ou ajouter une variable
          update_env() {
            local key="$1"
            local value="$2"
            if grep -q "^$key=" .env; then
              sed -i "s/^$key=.*/$key=$value/" .env
            else
              echo "$key=$value" >> .env
            fi
          }
          
          update_env "APP_ENV" "production"
          update_env "APP_DEBUG" "false"
          update_env "APP_URL" "http://${{ secrets.SSH_HOST }}"
          
          # Configuration de la base de donn√©es
          update_env "DB_CONNECTION" "mysql"
          update_env "DB_HOST" "127.0.0.1"
          update_env "DB_PORT" "3306"
          update_env "DB_DATABASE" "junglealert"
          update_env "DB_USERNAME" "work4connect"
          update_env "DB_PASSWORD" "Work4Connect2024!"
          
          echo "4Ô∏è‚É£ Installation des d√©pendances Composer..."
          composer install --no-dev --optimize-autoloader --no-interaction
          
          echo "5Ô∏è‚É£ G√©n√©ration de la cl√© d'application..."
          php artisan key:generate --force
          
          echo "6Ô∏è‚É£ Migration de la base de donn√©es..."
          php artisan migrate --force || echo "‚ö†Ô∏è Migration √©chou√©e ou d√©j√† effectu√©e"
          
          echo "7Ô∏è‚É£ Optimisation du cache..."
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          echo "8Ô∏è‚É£ Gestion des permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Cr√©er les r√©pertoires de logs si n√©cessaire
          mkdir -p storage/logs
          touch storage/logs/laravel.log
          sudo chown www-data:www-data storage/logs/laravel.log
          chmod 664 storage/logs/laravel.log
          
          echo "‚úÖ Configuration Laravel termin√©e"
          CONFIG_SCRIPT

      - name: üóÑÔ∏è Configuration de la base de donn√©es
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üóÑÔ∏è Configuration MySQL/MariaDB..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'MYSQL_SCRIPT'
          set -ex
          
          echo "=== CONFIGURATION BASE DE DONN√âES ==="
          
          # V√©rifier et installer MySQL/MariaDB
          if ! command -v mysql &> /dev/null; then
            echo "üì¶ Installation de MariaDB..."
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mariadb-server mariadb-client
            
            # D√©marrer le service
            sudo systemctl start mariadb
            sudo systemctl enable mariadb
            
            # Configuration s√©curis√©e minimale
            echo "üîß Configuration s√©curis√©e..."
            sudo mysql << 'MYSQL_SECURE'
            UPDATE mysql.user SET Password=PASSWORD('Work4Connect2024!') WHERE User='root';
            DELETE FROM mysql.user WHERE User='';
            DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
            DROP DATABASE IF EXISTS test;
            DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
            FLUSH PRIVILEGES;
            MYSQL_SECURE
          else
            echo "‚úÖ MySQL/MariaDB d√©j√† install√©"
          fi
          
          # V√©rifier que le service tourne
          sudo systemctl start mysql 2>/dev/null || sudo systemctl start mariadb 2>/dev/null || true
          sudo systemctl enable mysql 2>/dev/null || sudo systemctl enable mariadb 2>/dev/null || true
          
          sleep 3
          
          # Cr√©er la base de donn√©es et l'utilisateur
          echo "üóÑÔ∏è Cr√©ation de la base de donn√©es..."
          
          # Essayer diff√©rentes m√©thodes de connexion
          DB_CREATED=false
          
          # M√©thode 1: Sans mot de passe (installation fra√Æche)
          if sudo mysql -e "CREATE DATABASE IF NOT EXISTS junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>/dev/null; then
            echo "‚úÖ Base de donn√©es cr√©√©e"
            DB_CREATED=true
            
            sudo mysql -e "CREATE USER IF NOT EXISTS 'work4connect'@'localhost' IDENTIFIED BY 'Work4Connect2024!';" 2>/dev/null || \
              echo "‚ö†Ô∏è Utilisateur peut d√©j√† exister"
            
            sudo mysql -e "GRANT ALL PRIVILEGES ON junglealert.* TO 'work4connect'@'localhost';" 2>/dev/null || \
              echo "‚ö†Ô∏è Impossible d'accorder les privil√®ges"
            
            sudo mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || \
              echo "‚ö†Ô∏è Impossible de flush les privil√®ges"
          
          # M√©thode 2: Avec mot de passe root
          elif sudo mysql -u root -p'Work4Connect2024!' -e "CREATE DATABASE IF NOT EXISTS junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>/dev/null; then
            echo "‚úÖ Base de donn√©es cr√©√©e (avec authentification)"
            DB_CREATED=true
            
            sudo mysql -u root -p'Work4Connect2024!' -e "CREATE USER IF NOT EXISTS 'work4connect'@'localhost' IDENTIFIED BY 'Work4Connect2024!';" 2>/dev/null
            sudo mysql -u root -p'Work4Connect2024!' -e "GRANT ALL PRIVILEGES ON junglealert.* TO 'work4connect'@'localhost';" 2>/dev/null
            sudo mysql -u root -p'Work4Connect2024!' -e "FLUSH PRIVILEGES;" 2>/dev/null
          
          else
            echo "‚ö†Ô∏è Impossible de cr√©er la base de donn√©es automatiquement"
            echo "‚ÑπÔ∏è La base de donn√©es peut d√©j√† exister ou il y a un probl√®me d'authentification"
          fi
          
          # V√©rifier la connexion avec l'utilisateur de l'application
          if mysql -u work4connect -p'Work4Connect2024!' -e "SHOW DATABASES;" 2>/dev/null; then
            echo "‚úÖ Connexion √† la base de donn√©es r√©ussie"
          else
            echo "‚ö†Ô∏è Impossible de se connecter avec l'utilisateur de l'application"
            echo "‚ÑπÔ∏è Vous devrez peut-√™tre configurer manuellement la base de donn√©es"
          fi
          
          echo "=== CONFIGURATION BASE DE DONN√âES TERMIN√âE ==="
          MYSQL_SCRIPT

      - name: üåê Configuration d'Apache
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üåê Configuration d'Apache..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'APACHE_SCRIPT'
          set -ex
          
          echo "=== CONFIGURATION APACHE ==="
          
          # Installer Apache si n√©cessaire
          if ! command -v apache2 &> /dev/null; then
            echo "üì¶ Installation d'Apache..."
            sudo apt-get update
            sudo apt-get install -y apache2
          fi
          
          # Activer les modules
          echo "‚öôÔ∏è Activation des modules Apache..."
          sudo a2enmod rewrite
          sudo a2enmod headers
          
          # D√©sactiver le site par d√©faut
          echo "üö´ D√©sactivation du site par d√©faut..."
          sudo a2dissite 000-default.conf 2>/dev/null || true
          
          # Cr√©er la configuration du site
          echo "‚öôÔ∏è Cr√©ation de la configuration Apache..."
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          SERVER_HOST="${{ secrets.SSH_HOST }}"
          
          sudo tee /etc/apache2/sites-available/jungle-alert.conf > /dev/null << VIRTUAL_HOST
          <VirtualHost *:80>
              ServerName ${SERVER_HOST}
              ServerAdmin admin@jungle-alert.com
              DocumentRoot ${DEPLOY_PATH}/public
              
              <Directory ${DEPLOY_PATH}/public>
                  Options -Indexes +FollowSymLinks
                  AllowOverride All
                  Require all granted
                  
                  <IfModule mod_rewrite.c>
                      RewriteEngine On
                      RewriteCond %{REQUEST_FILENAME} !-d
                      RewriteCond %{REQUEST_FILENAME} !-f
                      RewriteRule ^ index.php [L]
                  </IfModule>
              </Directory>
              
              # Headers de s√©curit√©
              Header always set X-Content-Type-Options "nosniff"
              Header always set X-Frame-Options "SAMEORIGIN"
              
              ErrorLog \${APACHE_LOG_DIR}/jungle-alert-error.log
              CustomLog \${APACHE_LOG_DIR}/jungle-alert-access.log combined
              
              # PHP configuration
              <FilesMatch \.php$>
                  SetHandler application/x-httpd-php
              </FilesMatch>
          </VirtualHost>
          VIRTUAL_HOST
          
          # Activer le site
          echo "‚úÖ Activation du site jungle-alert..."
          sudo a2ensite jungle-alert.conf
          
          # Tester la configuration
          echo "üîß Test de la configuration Apache..."
          sudo apache2ctl configtest
          
          # Red√©marrer Apache
          echo "üîÑ Red√©marrage d'Apache..."
          sudo systemctl restart apache2
          
          # V√©rifier qu'Apache fonctionne
          sleep 3
          if systemctl is-active --quiet apache2; then
            echo "‚úÖ Apache configur√© et d√©marr√©"
            
            # Tester le site
            echo "üåê Test du site..."
            if curl -s -o /dev/null -w "%{http_code}" http://localhost/ | grep -q "200\|302\|301"; then
              echo "‚úÖ Site accessible localement"
            else
              echo "‚ö†Ô∏è Site non accessible localement, v√©rifiez les logs"
            fi
          else
            echo "‚ùå Apache ne fonctionne pas"
            echo "=== LOGS D'ERREUR ==="
            sudo journalctl -u apache2 --no-pager -n 50
            echo "=== CONFIGURATION TEST√âE ==="
            sudo apache2ctl -S 2>&1 | head -20
            exit 1
          fi
          
          echo "=== CONFIGURATION APACHE TERMIN√âE ==="
          APACHE_SCRIPT

      - name: üß™ Tests finaux
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üß™ Tests finaux de d√©ploiement..."
          sleep 10
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'FINAL_TESTS'
          set -ex
          
          echo "=== TESTS FINAUX ==="
          
          echo "1Ô∏è‚É£ Services en cours d'ex√©cution :"
          echo "   Apache: $(systemctl is-active apache2)"
          echo "   MySQL: $(systemctl is-active mysql 2>/dev/null || systemctl is-active mariadb 2>/dev/null || echo 'inactif')"
          
          echo "2Ô∏è‚É£ V√©rification PHP :"
          php --version | head -1
          
          echo "3Ô∏è‚É£ Test de l'application Laravel :"
          cd ${{ env.DEPLOY_PATH }}
          php artisan --version && echo "‚úÖ Laravel fonctionne" || echo "‚ùå Laravel ne fonctionne pas"
          
          echo "4Ô∏è‚É£ Test de connexion √† la base de donn√©es :"
          php artisan db:show 2>/dev/null && echo "‚úÖ Base de donn√©es accessible" || echo "‚ö†Ô∏è Base de donn√©es non accessible"
          
          echo "5Ô∏è‚É£ Test HTTP local :"
          HTTP_RESPONSE=$(curl -s -o /dev/null -w "%{http_code} %{url_effective}" http://localhost/ 2>/dev/null || echo "000 ")
          echo "   Status: $(echo \$HTTP_RESPONSE | cut -d' ' -f1)"
          
          echo "6Ô∏è‚É£ V√©rification des fichiers :"
          ls -la ${{ env.DEPLOY_PATH }}/public/index.php && echo "‚úÖ Fichier index.php pr√©sent" || echo "‚ùå Fichier index.php manquant"
          
          echo "7Ô∏è‚É£ Logs r√©cents :"
          if [ -f ${{ env.DEPLOY_PATH }}/storage/logs/laravel.log ]; then
            echo "üìã Derni√®res lignes des logs Laravel :"
            tail -5 ${{ env.DEPLOY_PATH }}/storage/logs/laravel.log
          else
            echo "üìã Aucun log Laravel trouv√©"
          fi
          
          echo "=== TESTS TERMIN√âS ==="
          FINAL_TESTS

      - name: üåê Test d'acc√®s externe
        run: |
          echo "üåê Test d'acc√®s externe √† l'application..."
          
          SERVER="${{ secrets.SSH_HOST }}"
          echo "üîç Test de l'application sur http://\$SERVER/"
          
          # Essayer plusieurs fois
          for attempt in {1..5}; do
            echo "Tentative \$attempt/5..."
            
            if curl -f --max-time 20 http://\$SERVER/ > /dev/null 2>&1; then
              echo "‚úÖ SUCC√àS : Application accessible depuis l'ext√©rieur"
              echo "üîó URL publique : http://\$SERVER/"
              
              # Tester aussi l'API si disponible
              API_TEST=$(curl -s --max-time 10 http://\$SERVER/api/health 2>/dev/null || true)
              if [ -n "\$API_TEST" ]; then
                echo "‚úÖ API accessible : \$API_TEST"
              fi
              
              exit 0
            else
              echo "‚ö†Ô∏è √âchec de la tentative \$attempt"
              sleep 5
            fi
          done
          
          echo "‚ö†Ô∏è ATTENTION : L'application n'est pas accessible depuis l'ext√©rieur"
          echo "Cela peut √™tre d√ª √† :"
          echo "  1. Un pare-feu bloquant le port 80"
          echo "  2. Apache n'√©coute pas sur l'interface publique"
          echo "  3. Probl√®mes de r√©seau/routing"
          echo ""
          echo "‚ÑπÔ∏è L'application peut quand m√™me fonctionner localement sur le serveur."
          echo "Pour v√©rifier, connectez-vous au serveur et ex√©cutez :"
          echo "  curl http://localhost/"
          
          # Ne pas faire √©chouer le d√©ploiement pour √ßa
          echo "‚ö†Ô∏è Continuons malgr√© l'√©chec de l'acc√®s externe..."

      - name: üìä Rapport de d√©ploiement
        if: always()
        run: |
          echo "## üöÄ Rapport de D√©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application :** Jungle Alert Laravel" >> $GITHUB_STEP_SUMMARY
          echo "**Environnement :** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Serveur :** ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chemin :** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date :** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if job.status == 'success'; then
            echo "‚úÖ **Statut :** D√©ploiement r√©ussi" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã Ce qui a √©t√© install√© :" >> $GITHUB_STEP_SUMMARY
            echo "- PHP 8.2 avec toutes les extensions n√©cessaires" >> $GITHUB_STEP_SUMMARY
            echo "- MariaDB/MySQL" >> $GITHUB_STEP_SUMMARY
            echo "- Apache avec configuration optimis√©e" >> $GITHUB_STEP_SUMMARY
            echo "- Composer et d√©pendances Laravel" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîó Acc√®s :" >> $GITHUB_STEP_SUMMARY
            echo "- **URL publique :** http://${{ secrets.SSH_HOST }}/" >> $GITHUB_STEP_SUMMARY
            echo "- **API Health :** http://${{ secrets.SSH_HOST }}/api/health" >> $GITHUB_STEP_SUMMARY
            echo "- **R√©pertoire :** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîß Commandes utiles :" >> $GITHUB_STEP_SUMMARY
            echo "```bash" >> $GITHUB_STEP_SUMMARY
            echo "# V√©rifier les services" >> $GITHUB_STEP_SUMMARY
            echo "sudo systemctl status apache2" >> $GITHUB_STEP_SUMMARY
            echo "sudo systemctl status mysql" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Voir les logs" >> $GITHUB_STEP_SUMMARY
            echo "sudo tail -f /var/log/apache2/error.log" >> $GITHUB_STEP_SUMMARY
            echo "tail -f ${{ env.DEPLOY_PATH }}/storage/logs/laravel.log" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Statut :** √âchec du d√©ploiement" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîç √âtapes de d√©pannage :" >> $GITHUB_STEP_SUMMARY
            echo "1. **V√©rifiez les identifiants SSH** dans les secrets GitHub" >> $GITHUB_STEP_SUMMARY
            echo "2. **Connectez-vous au serveur** et v√©rifiez manuellement :" >> $GITHUB_STEP_SUMMARY
            echo "   - `sudo systemctl status apache2`" >> $GITHUB_STEP_SUMMARY
            echo "   - `sudo tail -50 /var/log/apache2/error.log`" >> $GITHUB_STEP_SUMMARY
            echo "   - `php -v` et `php -m`" >> $GITHUB_STEP_SUMMARY
            echo "3. **V√©rifiez les permissions** :" >> $GITHUB_STEP_SUMMARY
            echo "   - `ls -la ${{ env.DEPLOY_PATH }}/storage/`" >> $GITHUB_STEP_SUMMARY
            echo "   - `ls -la ${{ env.DEPLOY_PATH }}/bootstrap/cache/`" >> $GITHUB_STEP_SUMMARY
            echo "4. **Testez manuellement** :" >> $GITHUB_STEP_SUMMARY
            echo "   - `curl http://localhost/`" >> $GITHUB_STEP_SUMMARY
            echo "   - `cd ${{ env.DEPLOY_PATH }} && php artisan --version`" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup:
    name: üßπ Nettoyage
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Nettoyer les fichiers temporaires
        run: |
          echo "üßπ Nettoyage des fichiers temporaires..."
          rm -f .rsync-exclude 2>/dev/null || true
          echo "‚úÖ Nettoyage termin√©"