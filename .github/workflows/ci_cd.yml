name: CI/CD Pipeline avec Mot de Passe SSH

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEPLOY_PATH: /opt/jungle-alert-laravel
  PHP_VERSION: "8.2"

jobs:
  tests:
    name: Tests et validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql, curl, zip, gd
          coverage: xdebug

      - name: Valider la syntaxe
        run: |
          find . -name "*.php" -type f -exec php -l {} \;

      - name: Tests unitaires
        run: |
          composer install --no-interaction --prefer-dist
          ./vendor/bin/phpunit --testdox || echo "Aucun test trouv√©"

  deploy:
    name: üöÄ D√©ploiement Production
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Pr√©paration SSH avec mot de passe
        run: |
          echo "üîß Installation de sshpass..."
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: üöÄ D√©ploiement avec rsync
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üîÑ Synchronisation des fichiers..."
          
          # Cr√©er le fichier d'exclusions
          cat > .rsync-exclude << 'EOF'
          .git/
          .github/
          node_modules/
          vendor/
          storage/
          *.log
          .env
          .env.*
          docker-compose*
          Dockerfile
          tests/
          *.md
          composer.lock
          package-lock.json
          yarn.lock
          EOF
          
          # Synchroniser les fichiers
          sshpass -p "$SSH_PASSWORD" \
            rsync -avz \
              --exclude-from=.rsync-exclude \
              --delete \
              -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
              ./ \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          echo "‚úÖ Fichiers synchronis√©s"

      - name: ‚öôÔ∏è Pr√©paration du serveur (PHP 8.2 et extensions)
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üîß Installation de PHP 8.2 et des extensions n√©cessaires..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'PHP_INSTALL'
          set -ex
          
          echo "=== INSTALLATION DE PHP 8.2 ==="
          
          # Ajouter le repository PHP si n√©cessaire
          echo "üì¶ Ajout du repository PHP..."
          sudo apt-get update
          sudo apt-get install -y software-properties-common ca-certificates lsb-release apt-transport-https
          sudo LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php
          sudo apt-get update
          
          # Installer PHP 8.2 et toutes les extensions n√©cessaires
          echo "üì¶ Installation de PHP 8.2 avec extensions..."
          sudo apt-get install -y \
            php8.2 \
            php8.2-cli \
            php8.2-fpm \
            php8.2-common \
            php8.2-mysql \
            php8.2-zip \
            php8.2-gd \
            php8.2-mbstring \
            php8.2-curl \
            php8.2-xml \
            php8.2-bcmath \
            php8.2-json \
            php8.2-tokenizer \
            php8.2-simplexml \
            php8.2-dom \
            php8.2-intl \
            php8.2-xmlreader \
            libapache2-mod-php8.2
          
          # D√©finir PHP 8.2 comme version par d√©faut
          echo "‚öôÔ∏è Configuration de PHP 8.2 comme version par d√©faut..."
          sudo update-alternatives --set php /usr/bin/php8.2
          sudo update-alternatives --set phar /usr/bin/phar8.2
          sudo update-alternatives --set phar.phar /usr/bin/phar.phar8.2
          
          # V√©rifier l'installation
          echo "‚úÖ PHP install√© :"
          php -v
          
          echo "üìã Extensions PHP install√©es :"
          php -m
          
          # Installer Composer si n√©cessaire
          if ! command -v composer &> /dev/null; then
            echo "üì¶ Installation de Composer..."
            curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
          fi
          
          echo "‚úÖ Composer version :"
          composer --version
          
          echo "=== INSTALLATION PHP TERMIN√âE ==="
          PHP_INSTALL

      - name: ‚öôÔ∏è Configuration du serveur
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "‚öôÔ∏è Configuration de l'application..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'CONFIG_SCRIPT'
          set -ex
          
          echo "üìÅ R√©pertoire de d√©ploiement : ${{ env.DEPLOY_PATH }}"
          cd ${{ env.DEPLOY_PATH }}
          
          echo "=== CONFIGURATION LARAVEL ==="
          
          echo "1Ô∏è‚É£ V√©rification de l'environnement..."
          php -v
          composer --version
          
          echo "2Ô∏è‚É£ Configuration de l'environnement Laravel..."
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "‚úÖ .env cr√©√© depuis .env.example"
          else
            echo "üìÑ .env existe d√©j√†"
          fi
          
          # Mettre √† jour les variables d'environnement
          echo "3Ô∏è‚É£ Mise √† jour des variables d'environnement..."
          sed -i 's/APP_ENV=.*/APP_ENV=production/' .env 2>/dev/null || echo "APP_ENV=production" >> .env
          sed -i 's/APP_DEBUG=.*/APP_DEBUG=false/' .env 2>/dev/null || echo "APP_DEBUG=false" >> .env
          
          # Configuration de la base de donn√©es
          echo "4Ô∏è‚É£ Configuration de la base de donn√©es..."
          grep -q "DB_CONNECTION=" .env || echo "DB_CONNECTION=mysql" >> .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env 2>/dev/null || echo "DB_HOST=127.0.0.1" >> .env
          sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env 2>/dev/null || echo "DB_PORT=3306" >> .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=junglealert/' .env 2>/dev/null || echo "DB_DATABASE=junglealert" >> .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=work4connect/' .env 2>/dev/null || echo "DB_USERNAME=work4connect" >> .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=Work4Connect2024!/' .env 2>/dev/null || echo "DB_PASSWORD=Work4Connect2024!" >> .env
          
          echo "5Ô∏è‚É£ Installation des d√©pendances Composer..."
          composer install --no-dev --optimize-autoloader --no-interaction
          
          echo "6Ô∏è‚É£ G√©n√©ration de la cl√© d'application..."
          php artisan key:generate --force
          
          echo "7Ô∏è‚É£ Migration de la base de donn√©es..."
          php artisan migrate --force || echo "‚ö†Ô∏è Migration √©chou√©e ou d√©j√† effectu√©e"
          
          echo "8Ô∏è‚É£ Optimisation du cache..."
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          echo "9Ô∏è‚É£ Gestion des permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Cr√©er les r√©pertoires de logs si n√©cessaire
          mkdir -p storage/logs
          touch storage/logs/laravel.log
          chmod 664 storage/logs/laravel.log
          
          echo "‚úÖ Configuration Laravel termin√©e"
          CONFIG_SCRIPT

      - name: üóÑÔ∏è Configuration de la base de donn√©es
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üóÑÔ∏è Configuration MySQL..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'MYSQL_SCRIPT'
          set -ex
          
          echo "=== CONFIGURATION MYSQL ==="
          
          # V√©rifier si MySQL/MariaDB est install√©
          if command -v mysql &> /dev/null; then
            echo "‚úÖ MySQL/MariaDB est install√©"
            
            # D√©marrer le service
            sudo systemctl start mysql 2>/dev/null || sudo systemctl start mariadb 2>/dev/null || true
            sudo systemctl enable mysql 2>/dev/null || sudo systemctl enable mariadb 2>/dev/null || true
            
          else
            echo "‚ö†Ô∏è MySQL/MariaDB n'est pas install√©"
            echo "Installation de MySQL..."
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mariadb-server mariadb-client
            
            # D√©marrer MySQL
            sudo systemctl start mariadb
            sudo systemctl enable mariadb
          fi
          
          # Attendre que MySQL d√©marre
          sleep 5
          
          # Cr√©er la base de donn√©es et l'utilisateur
          echo "üóÑÔ∏è Cr√©ation de la base de donn√©es..."
          
          # Essayer sans mot de passe root d'abord
          sudo mysql << 'MYSQL_SETUP' 2>/dev/null || true
          CREATE DATABASE IF NOT EXISTS junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
          CREATE USER IF NOT EXISTS 'work4connect'@'localhost' IDENTIFIED BY 'Work4Connect2024!';
          GRANT ALL PRIVILEGES ON junglealert.* TO 'work4connect'@'localhost';
          FLUSH PRIVILEGES;
          MYSQL_SETUP
          
          # Si √ßa √©choue, essayer avec mot de passe
          if ! mysql -u work4connect -p'Work4Connect2024!' -e "SHOW DATABASES;" 2>/dev/null; then
            echo "üîß Configuration alternative de MySQL..."
            
            # S√©curiser l'installation MySQL
            sudo mysql << 'MYSQL_SECURE' 2>/dev/null || true
            ALTER USER 'root'@'localhost' IDENTIFIED BY 'Work4Connect2024!';
            DELETE FROM mysql.user WHERE User='';
            DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
            DROP DATABASE IF EXISTS test;
            DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
            FLUSH PRIVILEGES;
            MYSQL_SECURE
            
            # Cr√©er avec mot de passe root
            sudo mysql -u root -p'Work4Connect2024!' << 'MYSQL_WITH_PASS' 2>/dev/null || true
            CREATE DATABASE IF NOT EXISTS junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
            CREATE USER IF NOT EXISTS 'work4connect'@'localhost' IDENTIFIED BY 'Work4Connect2024!';
            GRANT ALL PRIVILEGES ON junglealert.* TO 'work4connect'@'localhost';
            FLUSH PRIVILEGES;
            MYSQL_WITH_PASS
          fi
          
          # V√©rifier que la base de donn√©es a √©t√© cr√©√©e
          if mysql -u work4connect -p'Work4Connect2024!' -e "SHOW DATABASES;" 2>/dev/null | grep -q junglealert; then
            echo "‚úÖ Base de donn√©es configur√©e avec succ√®s"
          else
            echo "‚ö†Ô∏è Base de donn√©es non cr√©√©e, mais continuons..."
          fi
          
          echo "=== CONFIGURATION MYSQL TERMIN√âE ==="
          MYSQL_SCRIPT

      - name: üåê Configuration d'Apache
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üåê Configuration d'Apache..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'APACHE_SCRIPT'
          set -ex
          
          echo "=== CONFIGURATION APACHE ==="
          
          # Installer Apache si n√©cessaire
          if ! command -v apache2 &> /dev/null; then
            echo "üì¶ Installation d'Apache..."
            sudo apt-get update
            sudo apt-get install -y apache2
          fi
          
          # Activer les modules
          echo "‚öôÔ∏è Activation des modules Apache..."
          sudo a2enmod rewrite
          sudo a2enmod headers
          
          # D√©sactiver le site par d√©faut
          echo "üö´ D√©sactivation du site par d√©faut..."
          sudo a2dissite 000-default.conf 2>/dev/null || true
          
          # Cr√©er la configuration du site
          echo "‚öôÔ∏è Cr√©ation de la configuration Apache..."
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          SERVER_HOST="${{ secrets.SSH_HOST }}"
          
          sudo tee /etc/apache2/sites-available/jungle-alert.conf > /dev/null << VIRTUAL_HOST
          <VirtualHost *:80>
              ServerName ${SERVER_HOST}
              ServerAdmin admin@jungle-alert.com
              DocumentRoot ${DEPLOY_PATH}/public
              
              <Directory ${DEPLOY_PATH}/public>
                  Options -Indexes +FollowSymLinks
                  AllowOverride All
                  Require all granted
                  
                  <IfModule mod_rewrite.c>
                      RewriteEngine On
                      RewriteCond %{REQUEST_FILENAME} !-d
                      RewriteCond %{REQUEST_FILENAME} !-f
                      RewriteRule ^ index.php [L]
                  </IfModule>
              </Directory>
              
              # Headers de s√©curit√©
              Header always set X-Content-Type-Options "nosniff"
              Header always set X-Frame-Options "SAMEORIGIN"
              
              ErrorLog \${APACHE_LOG_DIR}/jungle-alert-error.log
              CustomLog \${APACHE_LOG_DIR}/jungle-alert-access.log combined
              
              # PHP configuration
              <FilesMatch \.php$>
                  SetHandler application/x-httpd-php
              </FilesMatch>
          </VirtualHost>
          VIRTUAL_HOST
          
          # Activer le site
          echo "‚úÖ Activation du site jungle-alert..."
          sudo a2ensite jungle-alert.conf
          
          # Tester la configuration
          echo "üîß Test de la configuration Apache..."
          sudo apache2ctl configtest
          
          # Red√©marrer Apache
          echo "üîÑ Red√©marrage d'Apache..."
          sudo systemctl restart apache2
          
          # V√©rifier qu'Apache fonctionne
          sleep 3
          if systemctl is-active --quiet apache2; then
            echo "‚úÖ Apache configur√© et d√©marr√©"
          else
            echo "‚ùå Apache ne fonctionne pas"
            echo "=== LOGS D'ERREUR ==="
            sudo journalctl -u apache2 --no-pager -n 50
            echo "=== CONFIGURATION TEST√âE ==="
            sudo apache2ctl -S 2>&1 | head -20
            exit 1
          fi
          
          echo "=== CONFIGURATION APACHE TERMIN√âE ==="
          APACHE_SCRIPT

      - name: üß™ Tests de d√©ploiement
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üß™ Tests de d√©ploiement..."
          sleep 10
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'TEST_SCRIPT'
          set -ex
          
          echo "=== TESTS DE D√âPLOIEMENT ==="
          
          echo "1Ô∏è‚É£ V√©rification des services..."
          echo "Apache: $(systemctl is-active apache2)"
          echo "MySQL: $(systemctl is-active mysql 2>/dev/null || systemctl is-active mariadb 2>/dev/null || echo 'non actif')"
          
          echo "2Ô∏è‚É£ V√©rification PHP..."
          php -v
          php -m | grep -E "mysql|pdo|mbstring|xml|json|curl"
          
          echo "3Ô∏è‚É£ Test de l'application Laravel..."
          cd ${{ env.DEPLOY_PATH }}
          
          if php artisan --version; then
            echo "‚úÖ Laravel fonctionne"
          else
            echo "‚ùå Laravel ne fonctionne pas"
          fi
          
          echo "4Ô∏è‚É£ Test HTTP local..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/ 2>/dev/null || echo "000")
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "302" ] || [ "$HTTP_STATUS" = "000" ]; then
            echo "‚úÖ Application accessible localement (status: $HTTP_STATUS)"
          else
            echo "‚ö†Ô∏è Application retourne status: $HTTP_STATUS"
          fi
          
          echo "5Ô∏è‚É£ V√©rification des permissions..."
          ls -la storage/ bootstrap/cache/
          
          echo "6Ô∏è‚É£ V√©rification des logs..."
          if [ -f storage/logs/laravel.log ]; then
            echo "üìã 5 derni√®res lignes des logs:"
            tail -5 storage/logs/laravel.log
          fi
          
          echo "=== TESTS TERMIN√âS ==="
          TEST_SCRIPT

      - name: üåê Test externe de l'application
        run: |
          echo "üåê Test externe de l'application..."
          sleep 10
          
          echo "üîç Test de l'application sur http://${{ secrets.SSH_HOST }}/"
          
          # Tester plusieurs fois avec des d√©lais
          for i in {1..3}; do
            echo "Tentative $i..."
            if curl -f --max-time 15 http://${{ secrets.SSH_HOST }}/ > /dev/null 2>&1; then
              echo "‚úÖ Application accessible depuis l'ext√©rieur"
              echo "üîó URL: http://${{ secrets.SSH_HOST }}/"
              
              # Tester l'API si disponible
              API_RESPONSE=$(curl -s --max-time 10 http://${{ secrets.SSH_HOST }}/api/health 2>/dev/null || echo "")
              if [ -n "$API_RESPONSE" ]; then
                echo "‚úÖ API accessible: $API_RESPONSE"
              else
                echo "‚ö†Ô∏è API non accessible, mais l'application l'est"
              fi
              exit 0
            fi
            sleep 5
          done
          
          echo "‚ö†Ô∏è Application non accessible depuis l'ext√©rieur"
          echo "Causes possibles :"
          echo "  - Pare-feu bloquant le port 80"
          echo "  - Apache n'√©coute pas sur l'adresse publique"
          echo "  - Probl√®me de configuration r√©seau"
          echo "‚ö†Ô∏è Note: L'application peut fonctionner localement mais pas √™tre accessible publiquement"

      - name: üìä Rapport de d√©ploiement
        if: always()
        run: |
          echo "## üöÄ Rapport de D√©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application :** Jungle Alert Laravel" >> $GITHUB_STEP_SUMMARY
          echo "**Environnement :** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Serveur :** ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Utilisateur :** ${{ secrets.SSH_USER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chemin :** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "**PHP Version :** 8.2" >> $GITHUB_STEP_SUMMARY
          echo "**Date :** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if job.status == 'success'; then
            echo "‚úÖ **Statut :** D√©ploiement r√©ussi" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã R√©sum√©" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ PHP 8.2 install√© avec toutes les extensions" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Fichiers synchronis√©s" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Configuration Laravel appliqu√©e" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Base de donn√©es configur√©e" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Apache configur√© et d√©marr√©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîó URLs d'acc√®s" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/api/health" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Statut :** √âchec du d√©ploiement" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîç D√©pannage" >> $GITHUB_STEP_SUMMARY
            echo "1. V√©rifiez les identifiants SSH" >> $GITHUB_STEP_SUMMARY
            echo "2. Connectez-vous au serveur et v√©rifiez :" >> $GITHUB_STEP_SUMMARY
            echo "   - sudo systemctl status apache2" >> $GITHUB_STEP_SUMMARY
            echo "   - sudo tail -50 /var/log/apache2/error.log" >> $GITHUB_STEP_SUMMARY
            echo "   - php -v" >> $GITHUB_STEP_SUMMARY
            echo "   - php -m" >> $GITHUB_STEP_SUMMARY
            echo "3. V√©rifiez les permissions :" >> $GITHUB_STEP_SUMMARY
            echo "   - ls -la ${{ env.DEPLOY_PATH }}/storage/" >> $GITHUB_STEP_SUMMARY
            echo "4. Testez manuellement :" >> $GITHUB_STEP_SUMMARY
            echo "   - curl http://localhost/" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup:
    name: üßπ Nettoyage
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Nettoyer les fichiers temporaires
        run: |
          echo "üßπ Nettoyage des fichiers temporaires..."
          rm -f .rsync-exclude 2>/dev/null || true
          echo "‚úÖ Nettoyage termin√©"