name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  server-connection:
    name: V√©rifier la connexion au serveur
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Test SSH connection
        run: |
          echo "üîç Test de connexion SSH au serveur..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=10 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
                "echo '‚úÖ Connexion SSH r√©ussie!' && hostname && uptime"
        
      - name: V√©rifier l'acc√®s au r√©pertoire
        run: |
          echo "üìÅ V√©rification de l'acc√®s au r√©pertoire de d√©ploiement..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=10 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
                "test -d /opt/jungle-alert-laravel && echo '‚úÖ R√©pertoire existe' || echo '‚ö†Ô∏è R√©pertoire n existe pas (sera cr√©√© lors du d√©ploiement)'"

      - name: V√©rifier les services
        run: |
          echo "üîß V√©rification des services..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=10 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
                "php -v && composer --version && apache2 -v 2>&1 | head -1 || echo '‚ö†Ô∏è Apache non trouv√©'"

  deploy:
    name: D√©ployer sur le serveur
    runs-on: ubuntu-latest
    needs: server-connection
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Create deployment archive
        run: |
          echo "üì¶ Cr√©ation de l'archive de d√©ploiement..."
          tar -czf junglealert-laravel.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='vendor' \
            --exclude='.env' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='.github' \
            .

      - name: Upload archive to server
        run: |
          echo "üì§ Upload de l'archive vers le serveur..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            scp -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                junglealert-laravel.tar.gz \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/

      - name: Deploy on server
        run: |
          echo "üöÄ D√©ploiement sur le serveur..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          echo "üõë Arr√™t des services existants..."
          pkill -f "php artisan serve" || true
          systemctl stop jungle-alert-api || true
          
          echo "üíæ Sauvegarde du fichier .env..."
          REMOTE_PATH="/opt/jungle-alert-laravel"
          if [ -f $REMOTE_PATH/.env ]; then
            cp $REMOTE_PATH/.env /tmp/.env.backup
          fi
          
          echo "üßπ Nettoyage de l'ancienne installation..."
          if [ -d $REMOTE_PATH ]; then
            cd $REMOTE_PATH
            find . -mindepth 1 ! -name '.env' -delete || true
          else
            mkdir -p $REMOTE_PATH
          fi
          
          echo "üì¶ Extraction de l'archive..."
          cd $REMOTE_PATH
          tar -xzf /tmp/junglealert-laravel.tar.gz
          
          echo "‚úÖ Restauration du fichier .env..."
          if [ -f /tmp/.env.backup ]; then
            mv /tmp/.env.backup $REMOTE_PATH/.env
          elif [ ! -f $REMOTE_PATH/.env ]; then
            echo "üìù Cr√©ation du fichier .env..."
            cp $REMOTE_PATH/.env.example $REMOTE_PATH/.env
            cd $REMOTE_PATH
            php artisan key:generate
          fi
          
          cd $REMOTE_PATH
          
          echo "üì¶ Installation des d√©pendances..."
          composer install --no-dev --optimize-autoloader --no-interaction
          
          echo "üîê Configuration des permissions..."
          chown -R www-data:www-data $REMOTE_PATH
          chmod -R 755 $REMOTE_PATH
          chmod -R 775 $REMOTE_PATH/storage
          chmod -R 775 $REMOTE_PATH/bootstrap/cache
          
          echo "üóÑÔ∏è Ex√©cution des migrations..."
          php artisan migrate --force
          
          echo "‚è∞ Configuration du scheduler..."
          (crontab -l 2>/dev/null | grep -v "artisan schedule:run" ; echo "* * * * * cd $REMOTE_PATH && php artisan schedule:run >> /dev/null 2>&1") | crontab -
          
          echo "üßπ Nettoyage du cache..."
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          php artisan cache:clear
          
          echo "‚ö° Reconstruction du cache..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          echo "‚úÖ D√©ploiement du code termin√©"
          
          rm -f /tmp/junglealert-laravel.tar.gz
          
          echo "‚úÖ D√©ploiement termin√© avec succ√®s!"
          EOF

      - name: Test deployment
        run: |
          echo "üß™ Test du d√©ploiement..."
          sleep 5
          curl -f http://${{ secrets.SSH_HOST }}:8000/api/health || echo "‚ö†Ô∏è Test de sant√© √©chou√© (peut √™tre normal si l'endpoint n'existe pas)"

  configure-mysql:
    name: Configurer MySQL
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: V√©rifier et d√©marrer MySQL
        run: |
          echo "üîç V√©rification et d√©marrage de MySQL..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          echo "üîç V√©rification de MySQL..."
          systemctl start mysql || systemctl start mariadb || true
          systemctl enable mysql || systemctl enable mariadb || true
          sleep 2
          
          if ! systemctl is-active --quiet mysql && ! systemctl is-active --quiet mariadb; then
            echo "‚ö†Ô∏è  MySQL n'est pas d√©marr√©, tentative de d√©marrage..."
            systemctl start mysql || systemctl start mariadb || true
            sleep 3
          fi
          
          if systemctl is-active --quiet mysql || systemctl is-active --quiet mariadb; then
            echo "‚úÖ MySQL est en cours d'ex√©cution"
          else
            echo "‚ùå MySQL n'est pas d√©marr√©"
            exit 1
          fi
          
          REMOTE_PATH="/opt/jungle-alert-laravel"
          cd $REMOTE_PATH
          
          # Configurer la base de donn√©es dans .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env || echo "DB_HOST=127.0.0.1" >> .env
          sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env || echo "DB_PORT=3306" >> .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=junglealert/' .env || echo "DB_DATABASE=junglealert" >> .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=work4connect/' .env || echo "DB_USERNAME=work4connect" >> .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=Work4Connect2024!/' .env || echo "DB_PASSWORD=Work4Connect2024!" >> .env
          
          # Vider le cache de configuration avant de tester la connexion
          php artisan config:clear
          php artisan cache:clear
          
          # V√©rifier la connexion √† la base de donn√©es
          echo "üîç V√©rification de la connexion √† la base de donn√©es..."
          php artisan db:show || echo "‚ö†Ô∏è  Impossible de se connecter √† la base de donn√©es"
          
          # Cr√©er la base de donn√©es si elle n'existe pas
          echo "üóÑÔ∏è  Cr√©ation de la base de donn√©es si n√©cessaire..."
          mysql -u work4connect -p'Work4Connect2024!' -e "CREATE DATABASE IF NOT EXISTS junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" || echo "‚ö†Ô∏è  Impossible de cr√©er la base de donn√©es (peut-√™tre qu'elle existe d√©j√†)"
          
          echo "‚úÖ Configuration MySQL termin√©e"
          EOF

  configure-apache:
    name: Configurer Apache
    runs-on: ubuntu-latest
    needs: configure-mysql
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Configurer Apache
        run: |
          echo "üåê Configuration d'Apache..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
                "SERVER_IP='${{ secrets.SSH_HOST }}' && \
                cat > /etc/apache2/sites-available/jungle-alert-api.conf << 'APACHE_EOF'
          <VirtualHost *:80>
              ServerName ${SERVER_IP}
              DocumentRoot /opt/jungle-alert-laravel/public
              
              <Directory /opt/jungle-alert-laravel/public>
                  AllowOverride All
                  Require all granted
              </Directory>
              
              ErrorLog \${APACHE_LOG_DIR}/jungle-alert-api_error.log
              CustomLog \${APACHE_LOG_DIR}/jungle-alert-api_access.log combined
          </VirtualHost>

          <VirtualHost *:8000>
              ServerName ${SERVER_IP}
              DocumentRoot /opt/jungle-alert-laravel/public
              
              <Directory /opt/jungle-alert-laravel/public>
                  AllowOverride All
                  Require all granted
              </Directory>
              
              ErrorLog \${APACHE_LOG_DIR}/jungle-alert-api_error.log
              CustomLog \${APACHE_LOG_DIR}/jungle-alert-api_access.log combined
          </VirtualHost>
          APACHE_EOF
          && \
          a2ensite jungle-alert-api.conf || true && \
          a2dissite 000-default.conf || true && \
          a2enmod rewrite || true && \
          a2enmod headers || true && \
          apache2ctl configtest && \
          systemctl restart apache2 && \
          echo '‚úÖ Apache configur√©'"

  start-services:
    name: D√©marrer les services
    runs-on: ubuntu-latest
    needs: configure-apache
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: D√©marrer l'API Laravel
        run: |
          echo "üöÄ D√©marrage des services..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          REMOTE_PATH="/opt/jungle-alert-laravel"
          cd $REMOTE_PATH
          
          # Arr√™ter les instances existantes
          pkill -f "php artisan serve" || true
          sleep 2
          
          # D√©marrer l'API en arri√®re-plan sur le port 8001
          nohup php artisan serve --host=0.0.0.0 --port=8001 > /var/log/jungle-alert-laravel.log 2>&1 &
          
          sleep 3
          
          # V√©rifier que le processus est en cours d'ex√©cution
          if pgrep -f "php artisan serve" > /dev/null; then
            echo "‚úÖ API Laravel d√©marr√©e sur le port 8001"
          else
            echo "‚ùå √âchec du d√©marrage de l'API"
            exit 1
          fi
          EOF

  test-deployment:
    name: Tester le d√©ploiement
    runs-on: ubuntu-latest
    needs: start-services
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Test API sur tous les ports
        run: |
          echo "üß™ Test de l'API sur tous les ports..."
          sleep 5
          
          echo "üîç Test sur le port 80..."
          curl -f --max-time 10 http://${{ secrets.SSH_HOST }}/api/health || echo "‚ö†Ô∏è Test de sant√© sur port 80 √©chou√©"
          
          echo "üîç Test sur le port 8000..."
          curl -f --max-time 10 http://${{ secrets.SSH_HOST }}:8000/api/health || echo "‚ö†Ô∏è Test de sant√© sur port 8000 √©chou√©"
          
          echo "üîç Test sur le port 8001..."
          curl -f --max-time 10 http://${{ secrets.SSH_HOST }}:8001/api/health || echo "‚ö†Ô∏è Test de sant√© sur port 8001 √©chou√©"
          
          echo "‚úÖ Tests termin√©s"
