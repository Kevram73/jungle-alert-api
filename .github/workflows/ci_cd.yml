name: CI/CD Pipeline avec Actions Tierces

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEPLOY_PATH: /opt/jungle-alert-laravel
  PHP_VERSION: "8.2"

jobs:
  tests:
    name: Tests et validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql
          coverage: xdebug

      - name: Valider la syntaxe
        run: |
          find . -name "*.php" -type f -exec php -l {} \;

      - name: Tests unitaires
        run: |
          composer install --no-interaction --prefer-dist
          ./vendor/bin/phpunit --testdox || echo "Aucun test trouv√©"

  deploy:
    name: üöÄ D√©ploiement Production
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê D√©ploiement via SSH
        uses: easingthemes/ssh-deploy@v4.1.8
        id: deploy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.SSH_HOST }}
          REMOTE_USER: ${{ secrets.SSH_USER }}
          REMOTE_PORT: ${{ secrets.SSH_PORT || '22' }}
          TARGET: ${{ env.DEPLOY_PATH }}
          EXCLUDE: |
            **/.git*
            **/.github*
            **/node_modules/**
            **/vendor/**
            **/storage/*
            **/*.log
            **/.env
            **/.env.*
            **/docker-compose*
            **/Dockerfile
            **/tests/
            **/*.md
            **/composer.lock
            **/package-lock.json
            **/yarn.lock
          ARGS: '-avz --delete'

      - name: ‚öôÔ∏è Configuration du serveur
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -e
            echo "üìÅ R√©pertoire de d√©ploiement : ${{ env.DEPLOY_PATH }}"
            cd ${{ env.DEPLOY_PATH }}
            
            echo "1Ô∏è‚É£ V√©rification de l'environnement..."
            php -v
            composer --version
            mysql --version || echo "MySQL non install√©"
            
            echo "2Ô∏è‚É£ Configuration de l'environnement Laravel..."
            if [ ! -f .env ]; then
              cp .env.example .env
              echo "‚úÖ .env cr√©√© depuis .env.example"
            fi
            
            # Mettre √† jour les variables d'environnement
            if grep -q "APP_ENV=" .env; then
              sed -i 's/APP_ENV=.*/APP_ENV=production/' .env
            else
              echo "APP_ENV=production" >> .env
            fi
            
            if grep -q "APP_DEBUG=" .env; then
              sed -i 's/APP_DEBUG=.*/APP_DEBUG=false/' .env
            else
              echo "APP_DEBUG=false" >> .env
            fi
            
            # Configuration de la base de donn√©es
            cat >> .env << 'ENV_CONFIG'
            DB_CONNECTION=mysql
            DB_HOST=127.0.0.1
            DB_PORT=3306
            DB_DATABASE=junglealert
            DB_USERNAME=work4connect
            DB_PASSWORD=Work4Connect2024!
            ENV_CONFIG
            
            echo "3Ô∏è‚É£ Installation des d√©pendances Composer..."
            composer install --no-dev --optimize-autoloader --no-interaction
            
            echo "4Ô∏è‚É£ G√©n√©ration de la cl√© d'application..."
            php artisan key:generate --force
            
            echo "5Ô∏è‚É£ Migration de la base de donn√©es..."
            php artisan migrate --force || echo "‚ö†Ô∏è Migration √©chou√©e ou d√©j√† effectu√©e"
            
            echo "6Ô∏è‚É£ Optimisation du cache..."
            php artisan config:clear
            php artisan cache:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "7Ô∏è‚É£ Gestion des permissions..."
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            
            # Cr√©er les r√©pertoires de logs si n√©cessaire
            mkdir -p storage/logs
            touch storage/logs/laravel.log
            chmod 664 storage/logs/laravel.log
            
            echo "‚úÖ Configuration termin√©e"

      - name: üóÑÔ∏è Configuration de la base de donn√©es
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üóÑÔ∏è Configuration MySQL..."
            
            # V√©rifier si MySQL/MariaDB est install√©
            if command -v mysql &> /dev/null; then
              echo "‚úÖ MySQL/MariaDB est install√©"
              
              # D√©marrer le service
              sudo systemctl start mysql 2>/dev/null || sudo systemctl start mariadb 2>/dev/null || true
              
              # Cr√©er la base de donn√©es et l'utilisateur
              sudo mysql << 'MYSQL_EOF'
              CREATE DATABASE IF NOT EXISTS junglealert 
                CHARACTER SET utf8mb4 
                COLLATE utf8mb4_unicode_ci;
              
              CREATE USER IF NOT EXISTS 'work4connect'@'localhost' 
                IDENTIFIED BY 'Work4Connect2024!';
              
              GRANT ALL PRIVILEGES ON junglealert.* 
                TO 'work4connect'@'localhost';
              
              FLUSH PRIVILEGES;
              MYSQL_EOF
              
              echo "‚úÖ Base de donn√©es configur√©e"
            else
              echo "‚ö†Ô∏è MySQL/MariaDB n'est pas install√©"
              echo "Installation de MySQL..."
              sudo apt-get update
              sudo apt-get install -y mariadb-server mariadb-client
              sudo mysql_secure_installation --use-default << 'EOF'
              y
              Work4Connect2024!
              Work4Connect2024!
              y
              y
              y
              y
              EOF
            fi

      - name: üåê Configuration d'Apache
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üåê Configuration d'Apache..."
            
            # Installer Apache si n√©cessaire
            if ! command -v apache2 &> /dev/null; then
              echo "üì¶ Installation d'Apache..."
              sudo apt-get update
              sudo apt-get install -y apache2 libapache2-mod-php
            fi
            
            # Activer les modules
            sudo a2enmod rewrite
            sudo a2enmod headers
            
            # Cr√©er la configuration du site
            sudo tee /etc/apache2/sites-available/jungle-alert.conf > /dev/null << 'APACHE_EOF'
            <VirtualHost *:80>
                ServerName ${{ secrets.SSH_HOST }}
                ServerAdmin admin@jungle-alert.com
                DocumentRoot ${{ env.DEPLOY_PATH }}/public
                
                <Directory ${{ env.DEPLOY_PATH }}/public>
                    Options -Indexes +FollowSymLinks
                    AllowOverride All
                    Require all granted
                    
                    <IfModule mod_rewrite.c>
                        RewriteEngine On
                        RewriteCond %{REQUEST_FILENAME} !-d
                        RewriteCond %{REQUEST_FILENAME} !-f
                        RewriteRule ^ index.php [L]
                    </IfModule>
                </Directory>
                
                # Headers de s√©curit√©
                Header always set X-Content-Type-Options "nosniff"
                Header always set X-Frame-Options "SAMEORIGIN"
                Header always set X-XSS-Protection "1; mode=block"
                
                ErrorLog ${APACHE_LOG_DIR}/jungle-alert-error.log
                CustomLog ${APACHE_LOG_DIR}/jungle-alert-access.log combined
            </VirtualHost>
            APACHE_EOF
            
            # Activer le site
            sudo a2ensite jungle-alert.conf
            sudo a2dissite 000-default.conf
            
            # Tester la configuration
            sudo apache2ctl configtest
            
            # Red√©marrer Apache
            sudo systemctl restart apache2
            
            echo "‚úÖ Apache configur√© et d√©marr√©"

      - name: üß™ Tests de d√©ploiement
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üß™ Tests de d√©ploiement..."
            sleep 5
            
            # Tester l'API
            echo "üîç Test de l'API..."
            curl -f --max-time 10 http://localhost/api/health \
              || curl -f --max-time 10 http://localhost/health \
              || curl -f --max-time 10 http://localhost/ \
              || echo "‚ö†Ô∏è Test API √©chou√©"
            
            # V√©rifier les logs Apache
            echo "üìã V√©rification des logs..."
            sudo tail -5 /var/log/apache2/jungle-alert-error.log 2>/dev/null || echo "Aucun log d'erreur"
            
            # V√©rifier le statut des services
            echo "‚ö° Statut des services..."
            sudo systemctl status apache2 --no-pager | head -10
            sudo systemctl status mysql --no-pager 2>/dev/null | head -10 \
              || sudo systemctl status mariadb --no-pager 2>/dev/null | head -10 \
              || echo "Service MySQL non trouv√©"

      - name: üìä Rapport de d√©ploiement
        if: always()
        run: |
          echo "## üöÄ Rapport de D√©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application :** Jungle Alert Laravel" >> $GITHUB_STEP_SUMMARY
          echo "**Environnement :** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Serveur :** ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chemin :** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if job.status == 'success'; then
            echo "‚úÖ **Statut :** D√©ploiement r√©ussi" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**URLs de test :**" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/api/health" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Statut :** √âchec du d√©ploiement" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consultez les logs ci-dessus pour plus de d√©tails." >> $GITHUB_STEP_SUMMARY
          fi

  cleanup:
    name: üßπ Nettoyage
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Nettoyer les artefacts
        run: |
          echo "üßπ Nettoyage des artefacts..."
          # Ajouter ici la logique de nettoyage si n√©cessaire