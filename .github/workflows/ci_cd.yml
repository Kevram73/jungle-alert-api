name: CI/CD Pipeline avec Mot de Passe SSH

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEPLOY_PATH: /opt/jungle-alert-laravel
  PHP_VERSION: "8.2"

jobs:
  tests:
    name: Tests et validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql
          coverage: xdebug

      - name: Valider la syntaxe
        run: |
          find . -name "*.php" -type f -exec php -l {} \;

      - name: Tests unitaires
        run: |
          composer install --no-interaction --prefer-dist
          ./vendor/bin/phpunit --testdox || echo "Aucun test trouv√©"

  deploy:
    name: üöÄ D√©ploiement Production
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Pr√©paration SSH avec mot de passe
        run: |
          echo "üîß Installation de sshpass..."
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: üöÄ D√©ploiement avec rsync
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üîÑ Synchronisation des fichiers..."
          
          # Cr√©er le fichier d'exclusions
          cat > .rsync-exclude << 'EOF'
          .git/
          .github/
          node_modules/
          vendor/
          storage/
          *.log
          .env
          .env.*
          docker-compose*
          Dockerfile
          tests/
          *.md
          composer.lock
          package-lock.json
          yarn.lock
          EOF
          
          # Synchroniser les fichiers
          sshpass -p "$SSH_PASSWORD" \
            rsync -avz \
              --exclude-from=.rsync-exclude \
              --delete \
              -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
              ./ \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          echo "‚úÖ Fichiers synchronis√©s"

      - name: ‚öôÔ∏è Configuration du serveur
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "‚öôÔ∏è Configuration de l'application..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          echo "üìÅ R√©pertoire de d√©ploiement : ${{ env.DEPLOY_PATH }}"
          cd ${{ env.DEPLOY_PATH }}
          
          echo "1Ô∏è‚É£ V√©rification de l'environnement..."
          php -v || echo "‚ùå PHP non install√©"
          composer --version || echo "‚ùå Composer non install√©"
          
          echo "2Ô∏è‚É£ Configuration de l'environnement Laravel..."
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "‚úÖ .env cr√©√© depuis .env.example"
          fi
          
          # Mettre √† jour les variables d'environnement
          if grep -q "APP_ENV=" .env; then
            sed -i 's/APP_ENV=.*/APP_ENV=production/' .env
          else
            echo "APP_ENV=production" >> .env
          fi
          
          if grep -q "APP_DEBUG=" .env; then
            sed -i 's/APP_DEBUG=.*/APP_DEBUG=false/' .env
          else
            echo "APP_DEBUG=false" >> .env
          fi
          
          # Configuration de la base de donn√©es
          cat >> .env << 'ENV_CONFIG'
          DB_CONNECTION=mysql
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=junglealert
          DB_USERNAME=work4connect
          DB_PASSWORD=Work4Connect2024!
          ENV_CONFIG
          
          echo "3Ô∏è‚É£ Installation des d√©pendances Composer..."
          composer install --no-dev --optimize-autoloader --no-interaction
          
          echo "4Ô∏è‚É£ G√©n√©ration de la cl√© d'application..."
          php artisan key:generate --force
          
          echo "5Ô∏è‚É£ Migration de la base de donn√©es..."
          php artisan migrate --force || echo "‚ö†Ô∏è Migration √©chou√©e ou d√©j√† effectu√©e"
          
          echo "6Ô∏è‚É£ Optimisation du cache..."
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          echo "7Ô∏è‚É£ Gestion des permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache
          
          # Cr√©er les r√©pertoires de logs si n√©cessaire
          mkdir -p storage/logs
          touch storage/logs/laravel.log
          chmod 664 storage/logs/laravel.log
          
          echo "‚úÖ Configuration termin√©e"
          EOF

      - name: üóÑÔ∏è Configuration de la base de donn√©es
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üóÑÔ∏è Configuration MySQL..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'MYSQL_SCRIPT'
          set -e
          
          echo "üîç V√©rification de MySQL..."
          
          # V√©rifier si MySQL/MariaDB est install√©
          if command -v mysql &> /dev/null; then
            echo "‚úÖ MySQL/MariaDB est install√©"
            
            # D√©marrer le service
            sudo systemctl start mysql 2>/dev/null || sudo systemctl start mariadb 2>/dev/null || true
            
            # V√©rifier si la base de donn√©es existe d√©j√†
            if mysql -u root -e "SHOW DATABASES LIKE 'junglealert';" | grep -q junglealert; then
              echo "üìä Base de donn√©es 'junglealert' existe d√©j√†"
            else
              echo "üóÑÔ∏è Cr√©ation de la base de donn√©es..."
              sudo mysql -e "CREATE DATABASE IF NOT EXISTS junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
              
              echo "üë§ Cr√©ation de l'utilisateur..."
              sudo mysql -e "CREATE USER IF NOT EXISTS 'work4connect'@'localhost' IDENTIFIED BY 'Work4Connect2024!';"
              
              echo "üîë Attribution des droits..."
              sudo mysql -e "GRANT ALL PRIVILEGES ON junglealert.* TO 'work4connect'@'localhost';"
              sudo mysql -e "FLUSH PRIVILEGES;"
              
              echo "‚úÖ Base de donn√©es et utilisateur cr√©√©s"
            fi
          else
            echo "‚ö†Ô∏è MySQL/MariaDB n'est pas install√©"
            echo "Installation de MySQL..."
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mariadb-server mariadb-client
            
            echo "üîß Configuration s√©curis√©e..."
            # Configuration s√©curis√©e simplifi√©e
            sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'Work4Connect2024!';"
            sudo mysql -e "DELETE FROM mysql.user WHERE User='';"
            sudo mysql -e "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"
            sudo mysql -e "DROP DATABASE IF EXISTS test;"
            sudo mysql -e "FLUSH PRIVILEGES;"
            
            # Cr√©er la base de donn√©es et l'utilisateur pour l'application
            sudo mysql -e "CREATE DATABASE junglealert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
            sudo mysql -e "CREATE USER 'work4connect'@'localhost' IDENTIFIED BY 'Work4Connect2024!';"
            sudo mysql -e "GRANT ALL PRIVILEGES ON junglealert.* TO 'work4connect'@'localhost';"
            sudo mysql -e "FLUSH PRIVILEGES;"
            
            echo "‚úÖ MySQL install√© et configur√©"
          fi
          
          echo "‚úÖ Configuration MySQL termin√©e"
          MYSQL_SCRIPT

      - name: üåê Configuration d'Apache avec d√©bogage
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üåê Configuration d'Apache avec v√©rifications..."
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'APACHE_SCRIPT'
          set -ex
          
          echo "=== D√âBUT CONFIGURATION APACHE ==="
          
          # V√©rifier l'√©tat d'Apache avant toute modification
          echo "üîç √âtat initial d'Apache..."
          sudo systemctl status apache2 --no-pager | head -20 || echo "‚ö†Ô∏è Apache n'est pas install√©"
          
          # Installer Apache si n√©cessaire
          if ! command -v apache2 &> /dev/null; then
            echo "üì¶ Installation d'Apache..."
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y apache2 libapache2-mod-php
          fi
          
          # V√©rifier que le r√©pertoire existe
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          echo "üìÅ V√©rification du r√©pertoire: \$DEPLOY_PATH"
          if [ ! -d "\$DEPLOY_PATH" ]; then
            echo "‚ùå R√©pertoire \$DEPLOY_PATH n'existe pas"
            exit 1
          fi
          
          if [ ! -d "\$DEPLOY_PATH/public" ]; then
            echo "‚ùå R√©pertoire \$DEPLOY_PATH/public n'existe pas"
            exit 1
          fi
          
          # Activer les modules
          echo "‚öôÔ∏è Activation des modules Apache..."
          sudo a2enmod rewrite
          sudo a2enmod headers
          
          # D√©sactiver le site par d√©faut d'abord
          echo "üö´ D√©sactivation du site par d√©faut..."
          sudo a2dissite 000-default.conf || true
          
          # Cr√©er la configuration du site avec un chemin absolu
          echo "‚öôÔ∏è Cr√©ation de la configuration Apache..."
          sudo tee /etc/apache2/sites-available/jungle-alert.conf > /dev/null << 'VIRTUAL_HOST'
          <VirtualHost *:80>
              ServerName ${{ secrets.SSH_HOST }}
              ServerAdmin admin@jungle-alert.com
              DocumentRoot ${{ env.DEPLOY_PATH }}/public
              
              <Directory ${{ env.DEPLOY_PATH }}/public>
                  Options -Indexes +FollowSymLinks
                  AllowOverride All
                  Require all granted
                  
                  <IfModule mod_rewrite.c>
                      RewriteEngine On
                      RewriteCond %{REQUEST_FILENAME} !-d
                      RewriteCond %{REQUEST_FILENAME} !-f
                      RewriteRule ^ index.php [L]
                  </IfModule>
              </Directory>
              
              # Headers de s√©curit√©
              Header always set X-Content-Type-Options "nosniff"
              Header always set X-Frame-Options "SAMEORIGIN"
              Header always set X-XSS-Protection "1; mode=block"
              
              ErrorLog \${APACHE_LOG_DIR}/jungle-alert-error.log
              CustomLog \${APACHE_LOG_DIR}/jungle-alert-access.log combined
              
              # Logs d√©taill√©s pour le d√©bogage
              LogLevel info
          </VirtualHost>
          VIRTUAL_HOST
          
          # Activer le site
          echo "‚úÖ Activation du site jungle-alert..."
          sudo a2ensite jungle-alert.conf
          
          # Tester la configuration
          echo "üîß Test de la configuration Apache..."
          if ! sudo apache2ctl configtest; then
            echo "‚ùå Erreur dans la configuration Apache"
            echo "=== DERNI√àRES LIGNES DES LOGS ==="
            sudo tail -20 /var/log/apache2/error.log || true
            echo "=== CONFIGURATION DU SITE ==="
            sudo cat /etc/apache2/sites-available/jungle-alert.conf
            exit 1
          fi
          
          # Arr√™ter Apache proprement avant de red√©marrer
          echo "‚èπÔ∏è Arr√™t d'Apache..."
          sudo systemctl stop apache2 || true
          sleep 2
          
          # V√©rifier qu'aucun processus Apache ne tourne encore
          if pgrep apache2; then
            echo "‚ö†Ô∏è Des processus Apache tournent encore, tentative de kill..."
            sudo pkill -9 apache2 || true
            sleep 2
          fi
          
          # Red√©marrer Apache
          echo "üîÑ D√©marrage d'Apache..."
          if ! sudo systemctl start apache2; then
            echo "‚ùå √âchec du d√©marrage d'Apache"
            echo "=== LOGS D'APACHE ==="
            sudo journalctl -u apache2 --no-pager -n 50
            echo "=== CONFIGURATION TEST√âE ==="
            sudo apache2ctl -S 2>&1 || true
            exit 1
          fi
          
          # V√©rifier qu'Apache fonctionne
          sleep 3
          echo "üîç V√©rification du statut d'Apache..."
          if systemctl is-active --quiet apache2; then
            echo "‚úÖ Apache configur√© et d√©marr√© avec succ√®s"
            echo "=== INFOS APACHE ==="
            sudo apache2ctl -S 2>&1 | head -20
          else
            echo "‚ùå Apache ne fonctionne pas"
            echo "=== DERNIERS LOGS ==="
            sudo journalctl -u apache2 --no-pager -n 30
            echo "=== ERREURS APACHE ==="
            sudo tail -30 /var/log/apache2/error.log || true
            exit 1
          fi
          
          echo "=== CONFIGURATION APACHE TERMIN√âE ==="
          APACHE_SCRIPT

      - name: üß™ V√©rification apr√®s configuration Apache
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üß™ V√©rification de la configuration Apache..."
          sleep 5
          
          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'VERIFY_SCRIPT'
          set -e
          
          echo "üîç V√©rifications post-configuration..."
          
          # 1. V√©rifier qu'Apache tourne
          echo "1Ô∏è‚É£ Statut d'Apache:"
          systemctl is-active apache2 && echo "‚úÖ Apache est actif" || echo "‚ùå Apache n'est pas actif"
          
          # 2. V√©rifier les processus
          echo "2Ô∏è‚É£ Processus Apache:"
          ps aux | grep apache | grep -v grep | wc -l | xargs echo "Nombre de processus Apache:"
          
          # 3. V√©rifier les ports en √©coute
          echo "3Ô∏è‚É£ Ports en √©coute:"
          sudo netstat -tlnp | grep :80 || echo "‚ö†Ô∏è Port 80 non en √©coute"
          
          # 4. V√©rifier les logs d'erreur
          echo "4Ô∏è‚É£ Derni√®res erreurs Apache:"
          sudo tail -10 /var/log/apache2/error.log 2>/dev/null | grep -i error || echo "‚úÖ Aucune erreur r√©cente"
          
          # 5. V√©rifier la configuration charg√©e
          echo "5Ô∏è‚É£ Configuration Apache charg√©e:"
          sudo apache2ctl -S 2>&1 | grep "jungle-alert" || echo "‚ö†Ô∏è Site jungle-alert non charg√©"
          
          # 6. Tester localement
          echo "6Ô∏è‚É£ Test local:"
          curl -I --max-time 5 http://localhost/ 2>/dev/null | head -1 || echo "‚ö†Ô∏è Impossible de se connecter localement"
          
          # 7. V√©rifier les permissions
          echo "7Ô∏è‚É£ Permissions du r√©pertoire:"
          ls -la ${{ env.DEPLOY_PATH }}/public/ | head -5
          
          echo "‚úÖ V√©rifications termin√©es"
          VERIFY_SCRIPT

      - name: üåê Test externe de l'API
        run: |
          echo "üåê Test externe de l'API..."
          sleep 10  # Donner plus de temps pour le d√©marrage
          
          # Essayer plusieurs ports
          echo "üîç Test de connectivit√© au serveur..."
          
          # D'abord v√©rifier que le serveur r√©pond sur le port SSH
          if nc -z -w 5 "${{ secrets.SSH_HOST }}" 22; then
            echo "‚úÖ Serveur accessible via SSH"
          else
            echo "‚ùå Serveur inaccessible"
            exit 1
          fi
          
          # Essayer le port 80
          echo "üîç Test sur le port 80..."
          if curl -f --max-time 10 http://${{ secrets.SSH_HOST }}/ > /dev/null 2>&1; then
            echo "‚úÖ Serveur r√©pond sur le port 80"
            
            # Tester l'API sp√©cifiquement
            echo "üîç Test de l'endpoint API..."
            API_RESPONSE=$(curl -s --max-time 10 http://${{ secrets.SSH_HOST }}/api/health 2>/dev/null || true)
            if [ -n "$API_RESPONSE" ]; then
              echo "‚úÖ API accessible - R√©ponse: $API_RESPONSE"
            else
              echo "‚ö†Ô∏è Endpoint API non accessible, test de la racine..."
              ROOT_RESPONSE=$(curl -s --max-time 10 http://${{ secrets.SSH_HOST }}/ 2>/dev/null || true)
              if [ -n "$ROOT_RESPONSE" ]; then
                echo "‚úÖ Racine accessible - Application d√©ploy√©e"
              else
                echo "‚ö†Ô∏è Application non accessible sur le port 80"
              fi
            fi
          else
            echo "‚ö†Ô∏è Serveur non accessible sur le port 80"
            echo "‚ö†Ô∏è V√©rifiez:"
            echo "  1. Le pare-feu autorise le port 80"
            echo "  2. Apache est d√©marr√© sur le serveur"
            echo "  3. La configuration Apache est correcte"
          fi

      - name: üìä Rapport de d√©ploiement
        if: always()
        run: |
          echo "## üöÄ Rapport de D√©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application :** Jungle Alert Laravel" >> $GITHUB_STEP_SUMMARY
          echo "**Environnement :** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Serveur :** ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Utilisateur :** ${{ secrets.SSH_USER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chemin :** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date :** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if job.status == 'success'; then
            echo "‚úÖ **Statut :** D√©ploiement r√©ussi" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã R√©sum√©" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Fichiers synchronis√©s" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Configuration Laravel appliqu√©e" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Base de donn√©es configur√©e" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Apache configur√©" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Tests API pass√©s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîó URLs d'acc√®s" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/" >> $GITHUB_STEP_SUMMARY
            echo "- http://${{ secrets.SSH_HOST }}/api/health" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Statut :** √âchec du d√©ploiement" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîç D√©pannage" >> $GITHUB_STEP_SUMMARY
            echo "1. V√©rifiez les logs ci-dessus" >> $GITHUB_STEP_SUMMARY
            echo "2. V√©rifiez les identifiants SSH" >> $GITHUB_STEP_SUMMARY
            echo "3. V√©rifiez que le serveur est accessible" >> $GITHUB_STEP_SUMMARY
            echo "4. V√©rifiez les logs Apache sur le serveur:" >> $GITHUB_STEP_SUMMARY
            echo "   - /var/log/apache2/error.log" >> $GITHUB_STEP_SUMMARY
            echo "   - /var/log/apache2/jungle-alert-error.log" >> $GITHUB_STEP_SUMMARY
            echo "5. V√©rifiez les permissions du r√©pertoire" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup:
    name: üßπ Nettoyage
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Nettoyer les fichiers temporaires
        run: |
          echo "üßπ Nettoyage des fichiers temporaires..."
          rm -f .rsync-exclude 2>/dev/null || true
          echo "‚úÖ Nettoyage termin√©"