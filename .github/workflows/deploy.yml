name: Deploy Laravel API

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permet de dÃ©clencher manuellement depuis GitHub

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Create deployment archive
        run: |
          cd ${{ github.workspace }}
          tar -czf junglealert-laravel.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='vendor' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='.env' \
            --exclude='.env.backup' \
            --exclude='.env.production' \
            --exclude='*.log' \
            --exclude='.phpunit.cache' \
            --exclude='tests' \
            --exclude='test_*.php' \
            --exclude='test_*.json' \
            --exclude='test_*.py' \
            --exclude='deploy_*.sh' \
            .

      - name: ğŸ“¤ Upload to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "junglealert-laravel.tar.gz"
          target: "/tmp/"

      - name: ğŸ”§ Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -e
            
            echo "ğŸš€ Starting deployment..."
            
            # ArrÃªter les services existants
            pkill -f "php artisan serve" || true
            systemctl stop jungle-alert-api || true
            
            # Supprimer l'ancienne installation
            rm -rf /var/www/html/jungle-alert-api
            
            # CrÃ©er le rÃ©pertoire
            mkdir -p /var/www/html/jungle-alert-api
            
            # Extraire l'archive
            cd /var/www/html/jungle-alert-api
            tar -xzf /tmp/junglealert-laravel.tar.gz --strip-components=1
            
            # Installer les dÃ©pendances PHP
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Configurer les permissions
            chown -R www-data:www-data /var/www/html/jungle-alert-api
            chmod -R 755 /var/www/html/jungle-alert-api
            chmod -R 775 /var/www/html/jungle-alert-api/storage
            chmod -R 775 /var/www/html/jungle-alert-api/bootstrap/cache
            
            # PrÃ©server le .env existant ou crÃ©er un nouveau
            if [ ! -f .env ]; then
              if [ -f .env.example ]; then
                cp .env.example .env
                php artisan key:generate --force
              fi
            fi
            
            # Configurer la base de donnÃ©es (seulement si .env n'existe pas)
            if [ ! -f .env.backup ]; then
              cp .env .env.backup || true
              sed -i 's/DB_HOST=127.0.0.1/DB_HOST=127.0.0.1/' .env || true
              sed -i 's/DB_DATABASE=laravel/DB_DATABASE=junglealert/' .env || true
              sed -i 's/DB_USERNAME=root/DB_USERNAME=work4connect/' .env || true
              sed -i 's/DB_PASSWORD=/DB_PASSWORD=Work4Connect2024!/' .env || true
            fi
            
            # ExÃ©cuter les migrations (ignorer les erreurs si les tables existent)
            php artisan migrate --force || echo "âš ï¸ Migrations skipped (tables may already exist)"
            
            # Nettoyer le cache
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            php artisan cache:clear
            
            # Reconstruire le cache
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "âœ… Installation terminÃ©e"

      - name: ğŸš€ Start API service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            cd /var/www/html/jungle-alert-api
            
            # ArrÃªter l'ancien processus s'il existe
            pkill -f "php artisan serve.*8001" || true
            sleep 2
            
            # DÃ©marrer l'API en arriÃ¨re-plan sur le port 8001
            nohup php artisan serve --host=0.0.0.0 --port=8001 > /var/log/jungle-alert-laravel.log 2>&1 &
            
            echo "âœ… API Laravel dÃ©marrÃ©e sur le port 8001"
            
            # Attendre un peu pour que le service dÃ©marre
            sleep 5

      - name: ğŸ§ª Test API health
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            # Tester l'endpoint de santÃ©
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/api/health || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "âœ… API health check passed (HTTP $response)"
              curl -s http://localhost:8001/api/health
            else
              echo "âŒ API health check failed (HTTP $response)"
              echo "ğŸ“‹ Last 50 lines of log:"
              tail -n 50 /var/log/jungle-alert-laravel.log || true
              exit 1
            fi

      - name: ğŸ§¹ Cleanup
        run: |
          rm -f junglealert-laravel.tar.gz

      - name: âœ… Deployment summary
        run: |
          echo "ğŸ‰ DÃ©ploiement terminÃ©!"
          echo "ğŸ“ API disponible sur: http://${{ secrets.SERVER_IP }}:8001"
          echo "ğŸ”— Endpoints:"
          echo "  - Health: GET /api/health"
          echo "  - Register: POST /api/v1/auth/register"
          echo "  - Login: POST /api/v1/auth/login"
          echo "  - Dashboard: GET /api/v1/dashboard"
          echo "  - Products: GET /api/v1/products"
          echo "  - Scrape Preview: POST /api/v1/products/scrape-preview"

